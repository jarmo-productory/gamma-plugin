# Sprint 1: Authentication Integration & Web Dashboard Foundation

*   **Goal:** Build upon Sprint 0's abstraction layers to implement Clerk authentication and create the initial web dashboard, while maintaining the extension's offline-first functionality.

## Prerequisites from Sprint 0
- ✅ Storage abstraction layer (`StorageManager`)
- ✅ Authentication abstraction layer (`AuthManager`)
- ✅ Configuration system with feature flags
- ✅ Enhanced build configuration
- ✅ TypeScript type definitions
- ✅ UI preparations (disabled auth buttons)

## Sprint 1 Prerequisites (Must Complete Before Development)

### Infrastructure Setup
- [ ] **Supabase Local Development Setup** - Database, API configuration, local environment
- [ ] **Clerk Account & Environment Setup** - Dev/staging/prod environments, API keys, OAuth providers
- [ ] **Local Development Environment Guide** - Complete setup from scratch including SSL, environment variables
- [ ] **Database Schema Design** - User profiles, presentations, relationships, migrations

### Design & UX Requirements  
- [ ] **Authentication UI Mockups** - Extension popup/sidebar auth elements, loading states, error handling
- [ ] **Web Dashboard Wireframes** - Landing page, dashboard layout, presentations list, responsive design
- [ ] **User Flow Diagrams** - Authentication flow, onboarding sequence, error recovery

### API & Security Specifications
- [ ] **API Endpoints Design** - Authentication, user management, basic CRUD operations
- [ ] **Security Architecture** - Token storage strategy, extension-web communication security
- [ ] **Deployment Configuration** - Netlify/Vercel setup, environment variables, SSL certificates

## Core Principles
- **Extension Independence**: Chrome extension continues to work without authentication
- **Graceful Enhancement**: Auth features enhance but don't replace local functionality
- **Shared Components**: Begin extracting reusable code for both platforms
- **Progressive Rollout**: Use feature flags to control feature visibility

## Deliverables

### 1. **Netlify Setup & CI/CD Configuration**
*Expected Time: 0.5-1 day*

**Early Deployment Setup:**
- [x] Create Netlify account and connect GitHub repository
- [x] Set up automatic deployment from main branch
- [x] Configure build settings and environment variables
- [x] Configure custom domain and SSL certificates *(not needed - using Netlify subdomain)*
- [x] Test deployment pipeline with minimal Vite app
- [x] Set up build notifications and monitoring *(not needed - email notifications already active)*
- [x] Document deployment process and troubleshooting

> **Note:** Staging/preview environments are not currently used. All deployments go directly from development to production. Staging will be added in the future as needed.

**Benefits of Early Setup:**
- ✅ Validate CI/CD pipeline early in development
- ✅ Catch deployment issues before they become blockers
- ✅ Enable continuous testing of authentication flows
- ✅ Allow for early user feedback on staging environment
- ✅ Establish proper environment variable management

### 2. **Infrastructure Setup & Configuration**
*Expected Time: 2-3 days*

**Supabase Setup:**
- [x] Create Supabase project and configure local development
- [x] Set up database schema with user profiles and presentations tables
- [x] Configure Row Level Security (RLS) policies
- [x] Create database migrations and seeding scripts
- [x] Set up local environment with `.env.local` configuration

**Clerk Configuration:**
- [x] Create Clerk application with development/production environments
- [x] Configure OAuth providers (Google, GitHub)
- [ ] Set up webhooks for user events
- [x] Configure domain allowlisting and CORS settings
- [x] Generate and manage API keys for different environments

**Local Development Environment:**
- [x] Create comprehensive setup guide with all prerequisites
- [x] Configure SSL certificates for local HTTPS development
- [x] Set up environment variable management
- [x] Configure database connection and testing procedures
- [x] Document troubleshooting common setup issues

### 3. **Database Schema & API Design**
*Expected Time: 1 day*

- [x] **Design Decision: Atomic Presentation Operations**
- [x] **Database Schema:** `users` and `presentations` tables are created and migrated.
- [x] **API Endpoints Design:** Core REST endpoints are auto-generated by Supabase. Custom endpoints (e.g., for sync) are designed and will be implemented alongside frontend features.

### 4. **UI/UX Design Implementation**
*Expected Time: 1-2 days*

**Authentication UI in Extension:**
- [ ] Design and implement sign-in button states
- [ ] Create loading indicators for authentication process
- [ ] Design user profile display with email and sign-out option
- [ ] Implement error states and retry mechanisms
- [ ] Create sync status indicators (connected/offline)

**Web Dashboard Interface:**
- [ ] Design landing page with clear value proposition
- [ ] Create sign-in/sign-up pages with Clerk components
- [ ] Design dashboard layout with navigation
- [ ] Create presentations list view with CRUD operations
- [ ] Implement responsive design for mobile devices

### 5. **Security & Authentication Architecture**
*Expected Time: 1 day*

**Token Storage Strategy:**
- [ ] Implement secure token storage in Chrome extension
- [ ] Configure token refresh mechanisms
- [ ] Set up session timeout and management
- [ ] Implement CSRF protection for API calls

**Extension-Web Communication Security:**
- [ ] Configure CORS settings for extension-web communication
- [ ] Implement secure message passing between extension and web
- [ ] Set up Content Security Policy (CSP) for web dashboard
- [ ] Configure SSL/HTTPS for all communications

### 6. **Production Environment Configuration**
*Expected Time: 0.5 day*

**Database Production Setup:**
- [ ] Set up Supabase production environment
- [ ] Configure database connection pooling
- [ ] Set up automated backups and monitoring
- [ ] Configure database migrations for production

**Final Deployment Configuration:**
- [ ] Update Netlify environment variables for production
- [ ] Configure production domain and SSL certificates
- [ ] Set up monitoring and error tracking
- [ ] Test production deployment pipeline

### 7. **Clerk Integration in Extension**
*Expected Time: 1-2 days*

*   Update `packages/shared/auth/index.ts` to integrate with Clerk:
    ```javascript
    import { config } from '../config/index.js';
    
    export class AuthManager {
      constructor() {
        this.token = null;
        this.user = null;
      }
      
      async initialize() {
        if (!config.features.authentication) {
          return; // Feature flag check
        }
        
        // Check for existing Clerk session
        try {
          const response = await fetch(`${config.api.baseUrl}/api/auth/me`, {
            credentials: 'include'
          });
          if (response.ok) {
            this.user = await response.json();
            this.token = await this.getToken();
          }
        } catch (error) {
          console.log('Auth check failed, continuing in offline mode');
        }
      }
      
      async signIn() {
        // Open web dashboard for authentication
        chrome.tabs.create({ 
          url: `${config.webDashboardUrl}/sign-in?from=extension&return=true` 
        });
      }
      
      async signOut() {
        this.token = null;
        this.user = null;
        // Notify UI components
        chrome.runtime.sendMessage({ type: 'auth-state-changed', authenticated: false });
      }
      
      async isAuthenticated() {
        return !!this.user && !!this.token;
      }
    }
    ```

### 8. **Web Dashboard Setup (Next.js)**
*Expected Time: 2-3 days*
*   Initialize Next.js app in `/web` directory:
    ```bash
    npx create-next-app@latest web --typescript --tailwind --app
    ```
*   Install and configure Clerk:
    ```bash
    npm install @clerk/nextjs
    ```
*   Create authentication pages:
    - `/web/app/sign-in/page.tsx`
    - `/web/app/sign-up/page.tsx`
    - `/web/app/dashboard/page.tsx`

### 9. **Extension UI Updates**
*Expected Time: 1-2 days*
*   Enable authentication UI in sidebar:
    ```javascript
    // sidebar.js updates
    const renderAuthSection = async () => {
      if (!config.features.authentication) {
        return ''; // Feature not enabled
      }
      
      const isAuthenticated = await auth.isAuthenticated();
      
      if (isAuthenticated) {
        return `
          <div class="auth-section">
            <span class="user-info">👤 ${auth.user.email}</span>
            <button id="sign-out-btn" class="auth-btn">Sign Out</button>
            <span class="sync-status">☁️ Sync Enabled</span>
          </div>
        `;
      } else {
        return `
          <div class="auth-section">
            <button id="sign-in-btn" class="auth-btn">🔐 Sign In</button>
            <span class="sync-status disabled">☁️ Local Only</span>
          </div>
        `;
      }
    };
    ```

### 10. **Shared Type Definitions**
*Expected Time: 1 day*
*   Create comprehensive types in `/shared/types/`:
    ```typescript
    // user.types.ts
    export interface User {
      id: string;
      email: string;
      name?: string;
      createdAt: Date;
      subscription: 'free' | 'pro' | 'team';
    }
    
    // auth.types.ts
    export interface AuthState {
      isAuthenticated: boolean;
      user: User | null;
      token: string | null;
    }
    
    // presentation.types.ts
    export interface Presentation {
      id: string;
      userId: string;
      title: string;
      gammaUrl: string; // Required unique identifier
      startTime: string;
      totalDuration: number;
      timetableData: TimetableData; // Complete timetable object
      createdAt: Date;
      updatedAt: Date;
    }
    
    export interface TimetableData {
      startTime: string;
      items: TimetableItem[];
      totalDuration: number;
    }
    
    export interface TimetableItem {
      id: string;
      title: string;
      content: SlideContent[];
      duration: number;
      startTime: string;
      endTime: string;
      order?: number;
      level?: number;
    }
    
    export interface SlideContent {
      type: 'paragraph' | 'image' | 'link' | 'list_item';
      text: string;
      subItems?: string[];
    }
    
    // sync.types.ts
    export interface SyncState {
      status: 'idle' | 'syncing' | 'error' | 'offline';
      lastSyncTime: Date | null;
      pendingChanges: number;
    }
    
    export interface SyncOperation {
      type: 'create' | 'update' | 'delete';
      entity: 'presentation';
      entityId: string;
      data?: TimetableData;
      timestamp: Date;
    }
    ```

### 11. **Extension-to-Web Communication**
*Expected Time: 1-2 days*
*   Implement post-authentication flow:
    ```javascript
    // background.js additions
    chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
      if (message.type === 'auth-callback') {
        // Handle return from web dashboard authentication
        auth.initialize().then(() => {
          // Notify all extension components
          chrome.runtime.sendMessage({ 
            type: 'auth-state-changed', 
            authenticated: true 
          });
        });
      }
    });
    ```

### 12. **Web Dashboard Structure**
*Expected Time: 1 day*
    ```
    /web/
      /app/
        /api/
          /auth/
            me/route.ts      # Check auth status
        /(auth)/
          /sign-in/
            page.tsx         # Clerk SignIn component
          /sign-up/
            page.tsx         # Clerk SignUp component
        /(dashboard)/
          /dashboard/
            page.tsx         # Protected dashboard
          /presentations/
            page.tsx         # List presentations
        layout.tsx           # Root layout with ClerkProvider
        page.tsx            # Landing page
      /components/
        Navigation.tsx       # Shared navigation
        AuthButton.tsx      # Reusable auth button
      /lib/
        auth.ts             # Auth utilities
      /public/
        # Static assets
    ```

### 13. **Feature Flag Configuration**
*Expected Time: 0.5 days*
*   Update config for Sprint 1:
    ```javascript
    // src/config/index.js
    export const config = {
      features: {
        cloudSync: false,        // Still false in Sprint 1
        authentication: true,    // Enable auth UI
        webDashboard: true,      // Enable dashboard
        autoSync: false         // Manual sync only for now
      },
      api: {
        baseUrl: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000'
      },
      webDashboardUrl: process.env.NEXT_PUBLIC_WEB_URL || 'http://localhost:3000'
    };
    ```

### 14. **Build Process Updates**
*Expected Time: 1 day*
*   Update package.json:
    ```json
    {
      "scripts": {
        "dev": "concurrently \"npm run dev:extension\" \"npm run dev:web\"",
        "dev:extension": "vite --mode extension",
        "dev:web": "cd web && npm run dev",
        "build": "npm run build:extension && npm run build:web",
        "build:extension": "vite build --mode extension",
        "build:web": "cd web && npm run build"
      }
    }
    ```

### 15. **Storage Manager Enhancement**
*Expected Time: 1 day*
*   Prepare for future cloud sync:
    ```javascript
    // src/lib/storage.js updates
    export class StorageManager {
      constructor(mode = 'local', auth = null) {
        this.mode = mode;
        this.auth = auth;
      }
      
      async save(key, data) {
        // Always save locally first
        const localResult = await saveData(key, data);
        
        // Prepare for cloud sync (Sprint 3)
        if (this.auth && await this.auth.isAuthenticated()) {
          // Queue for sync (not implemented yet)
          await this.queueForSync(key, data);
        }
        
        return localResult;
      }
      
      async queueForSync(key, data) {
        // Placeholder for Sprint 3 - atomic presentation sync
        const queue = await loadData('sync-queue') || [];
        queue.push({ 
          key, 
          data, // Complete timetable object
          timestamp: new Date(),
          operation: 'upsert' // Atomic upsert by gamma_url
        });
        await saveData('sync-queue', queue);
      }
    }
    ```

### 16. **User Onboarding Flow**
*Expected Time: 1 day*
*   Implement the flow from `app-flow-user-onboarding.md`:
    - Extension shows "Sign In" button when not authenticated
    - Clicking opens web dashboard in new tab
    - User completes auth on web
    - Web dashboard redirects back with success message
    - Extension detects auth completion and updates UI

## Migration Path

### From Sprint 0 → Sprint 1
1. **Enable Feature Flags**: Set `authentication: true` in config
2. **Deploy Web Dashboard**: Initial deployment to Netlify
3. **Update Extension**: Release with auth UI enabled
4. **Monitor**: Track adoption and error rates

### Data Flow with Auth (Sprint 1)
```
User Action → Extension → StorageManager
                              ↓
                    Save to Chrome Storage
                              ↓
                    Queue for Sync (if authenticated)
                              ↓
                    [Manual Sync Button - Sprint 2]
```

## Success Criteria

- [ ] Extension continues to work offline
- [ ] Users can sign in via web dashboard
- [ ] Auth state persists across browser sessions
- [ ] Web dashboard shows user's presentations (local data for now)
- [ ] No breaking changes to existing functionality
- [ ] Feature flags control feature visibility
- [ ] Clean separation between auth and core functionality

## Technical Specifications

### Environment Variables Required
```bash
# Clerk Configuration
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...

# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://...supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Application Configuration
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_EXTENSION_ID=chrome-extension://...
```

### Chrome Extension Manifest Updates
```json
{
  "permissions": [
    "activeTab",
    "scripting",
    "storage",
    "downloads",
    "sidePanel",
    "tabs",
    "identity"
  ],
  "host_permissions": [
    "https://gamma.app/*",
    "https://localhost:3000/*",
    "https://yourdomain.com/*"
  ]
}
```

### Security Headers Configuration
```javascript
// next.config.js
const securityHeaders = [
  {
    key: 'X-Frame-Options',
    value: 'DENY',
  },
  {
    key: 'Content-Security-Policy',
    value: "default-src 'self'; script-src 'self' 'unsafe-eval'; style-src 'self' 'unsafe-inline'",
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff',
  },
];
```

## Testing Strategy

### 1. **Development Testing**
- [ ] Unit tests for authentication functions
- [ ] Integration tests for API endpoints
- [ ] Extension functionality testing in Chrome
- [ ] Cross-browser compatibility testing

### 2. **User Acceptance Testing**
- [ ] Authentication flow from extension to web
- [ ] Offline functionality validation
- [ ] Data synchronization testing
- [ ] Error handling and recovery testing

### 3. **Security Testing**
- [ ] Token storage security validation
- [ ] CSRF protection testing
- [ ] XSS prevention validation
- [ ] API endpoint security testing

### 4. **Performance Testing**
- [ ] Extension performance impact testing
- [ ] Web dashboard loading speed testing
- [ ] Database query performance testing
- [ ] Memory usage optimization validation

## Sprint 1 Timeline & Effort Estimation

### Total Estimated Time: 15-19 days
**Prerequisites Phase (before development):** 3-4 days
**Development Phase:** 12-15 days

### Prerequisites Timeline
- **Day 1-2:** Infrastructure setup (Supabase, Clerk, local environment)
- **Day 3:** Database schema design and API planning
- **Day 4:** UI/UX mockups and security architecture

### Development Timeline
- **Day 1:** Netlify setup and CI/CD pipeline configuration
- **Week 1 (Days 2-5):** Infrastructure implementation, database setup, basic authentication
- **Week 2 (Days 6-10):** Web dashboard development, extension UI updates
- **Week 3 (Days 11-15):** Integration testing, security implementation, production configuration
- **Week 4 (Days 16+):** Final testing, bug fixes, documentation

### Risk Mitigation
- **Technical Risks:** Complex extension-web communication, token security
- **Timeline Risks:** Underestimated Clerk integration complexity
- **Mitigation:** Thorough prerequisites completion, regular testing, feature flag rollback capability

## Next Steps (Sprint 2 Preview)

- Implement manual sync functionality
- Add "Save to Cloud" / "Load from Cloud" buttons
- Create presentation management UI in dashboard
- Begin advanced Supabase integration for data storage
- Implement conflict resolution for data sync
- Add user subscription management 