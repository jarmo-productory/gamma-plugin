import{l as q,s as O,d as X,c as p,a as b,b as T,e as E,f as _}from"../assets/index.js";function $(e,t={}){const{startTime:n="09:00",defaultDuration:a=5,existingItems:i=[]}=t,o=new Date(`1970-01-01T${n}:00`);let s=0;const c=e.map(d=>{const u=i.find(h=>h.id===d.id),l=u?u.duration:a,m=new Date(o);o.setMinutes(o.getMinutes()+l);const f=new Date(o);return s+=l,{id:d.id,title:d.title,content:d.content,startTime:m.toTimeString().slice(0,5),endTime:f.toTimeString().slice(0,5),duration:l}});return{startTime:n,items:c,totalDuration:s}}function z(e,t,n=!1){const a=document.createElement("a");if(a.setAttribute("download",e),a.style.visibility="hidden",document.body.appendChild(a),n)a.href=t;else{const i=new Blob([t],{type:"text/csv;charset=utf-8;"});a.href=URL.createObjectURL(i)}a.click(),document.body.removeChild(a)}function P(e){var d;const t=((d=e.items[0])==null?void 0:d.title)||"Course Timetable",n=e.items.map(u=>[u.startTime,u.endTime,u.duration,u.title]),i=[[t],["Start","End","Duration","Slide title"],...n],o=XLSX.utils.aoa_to_sheet(i);o["!cols"]=[{wch:10},{wch:10},{wch:10},{wch:80}];const s=XLSX.utils.book_new();XLSX.utils.book_append_sheet(s,o,"Timetable");const c=XLSX.write(s,{bookType:"xlsx",type:"array"});return new Blob([c],{type:"application/octet-stream"})}function B(e,t){return O(e,t)}function W(e){return q(e)}function M(e,t){return X(e,t)}console.log("[SIDEBAR] Script loaded");const K="0.0.28";let C=!1,I=[],r=null,w=null,S=null,j=!1,G=!1;function V(e){if(!r){console.log("[SIDEBAR] No current timetable, generating a new one.");const i=$(e);D(i),A();return}console.log("[SIDEBAR] Reconciling new slide data with existing timetable.");const t=[],n=new Map(r.items.map(i=>[i.id,i]));for(const i of e){const o=n.get(i.id);o?t.push({...o,title:i.title,content:i.content}):t.push({...i,duration:5})}r.items=t;const a=L(r);D(a),A()}const J=async(e,t)=>{var a;if(console.log(`[SIDEBAR] updateUIWithNewSlides called for tab ${t} with`,(e==null?void 0:e.length)||0,"slides"),I=e||[],e.length===0){document.getElementById("sidebar-main").innerHTML="<p>No slides detected in this Gamma presentation.</p>",v(e,"Received: slide-data (empty)");return}const n=(a=e[0])==null?void 0:a.presentationUrl;if(n){if(n!==S){console.log(`[SIDEBAR] Switched to new presentation: ${n}. Loading from storage...`),S=n;const i=`timetable-${n}`;let o=await W(i);const s=p.getConfig();if(s.features.cloudSync&&s.environment.apiBaseUrl)try{const c=await T.syncFromCloud(n,{apiBaseUrl:s.environment.apiBaseUrl,deviceAuth:E});if(c.success&&c.data){console.log("[SIDEBAR] Found cloud version, merging with local...");const d=c.data;!o||d.lastModified&&o.lastModified&&new Date(d.lastModified)>new Date(o.lastModified)?(o=d,await B(i,d),console.log("[SIDEBAR] Using cloud version (newer than local).")):console.log("[SIDEBAR] Using local version (newer than cloud).")}else!c.success&&c.error!=="Presentation not found in cloud"&&console.warn("[SIDEBAR] Cloud sync failed:",c.error)}catch(c){console.warn("[SIDEBAR] Cloud sync error (non-critical):",c)}o?(console.log("[SIDEBAR] Found stored timetable."),r=o):(console.log("[SIDEBAR] No stored timetable, generating a new one..."),r=$(e))}V(e),v(e,"Rendered: slide-data")}};function Q(){if(console.log("[SIDEBAR] Connecting to background script..."),w=chrome.runtime.connect({name:"sidebar"}),console.log("[SIDEBAR] Connected to background"),!w){console.error("[SIDEBAR] Failed to create port connection");return}C=!0,v(I,"Connected to background"),w.onMessage.addListener(e=>{if(console.log("[SIDEBAR] Received message from background:",e),e.type==="slide-data")J(e.slides,e.tabId);else if(e.type==="gamma-tab-activated")e.tabId,document.getElementById("sidebar-main").innerHTML="<p>Loading timetable...</p>",w.postMessage({type:"get-slides"});else if(e.type==="show-message"){document.getElementById("sidebar-main").innerHTML=`<p>${e.message}</p>`;const t=document.getElementById("timetable-title");t&&(t.textContent="Gamma Timetable");const n=document.getElementById("duration-badge");n&&(n.textContent="0h 0m")}else e.type==="error"&&(console.error("[SIDEBAR] Error from background:",e.message),document.getElementById("sidebar-main").innerHTML=`<p style="color: red;">${e.message}</p>`)}),w.onDisconnect.addListener(()=>{w=null,C=!1,console.log("[SIDEBAR] Disconnected from background script."),v(I,"Disconnected")})}function Y(e){let t="";return e.forEach(n=>{switch(n.type){case"paragraph":t+=`<p>${n.text}</p>`;break;case"image":t+=`<img src="${n.text}" class="thumbnail-img">`;break;case"link":t+=`<a href="${n.text}" target="_blank" class="content-link">${n.text}</a>`;break;case"list_item":t+=`<p>${n.text}</p>`,n.subItems&&n.subItems.length>0&&(t+='<ul class="sub-items-list">',n.subItems.forEach(a=>{t+=`<li class="sub-item">${a}</li>`}),t+="</ul>");break}}),t}function Z(e,t){const n=document.createElement("div");n.className="time-input-container";const[a,i]=e.startTime.split(":"),o=document.createElement("input");o.type="text",o.className="time-input-segment",o.value=a,o.maxLength=2,o.placeholder="00";const s=document.createElement("span");s.className="time-input-separator",s.textContent=":";const c=document.createElement("input");c.type="text",c.className="time-input-segment",c.value=i,c.maxLength=2,c.placeholder="00";const u=M(()=>{const l=o.value.padStart(2,"0"),m=c.value.padStart(2,"0"),f=parseInt(l,10),h=parseInt(m,10);f>=0&&f<=23&&h>=0&&h<=59&&t(`${l}:${m}`)},400);return o.addEventListener("input",()=>{o.value.length>=2&&(o.value=o.value.slice(0,2),c.focus()),u()}),c.addEventListener("input",()=>{c.value.length>=2&&(c.value=c.value.slice(0,2)),u()}),n.appendChild(o),n.appendChild(s),n.appendChild(c),n}function ee(e=[],t="none",n={}){const{authFeatureEnabled:a=!1,isAuthenticated:i=!1,userEmail:o=""}=n,{debugMode:s=!1}=n,c=e.length,d=e[0]?JSON.stringify(e[0],null,2):"N/A",u=a,l=u&&s?i?`<div style="margin-top:6px;"><span>Logged in as <strong>${o||"user"}</strong></span> <button id="debug-logout-btn" class="export-btn" style="margin-left:8px;">Logout</button></div>`:'<div style="margin-top:6px;"><button id="debug-login-btn" class="export-btn">Login</button></div>':"";return`
        <strong>Debug Info (v${K})</strong><br>
        Auth Feature: <strong style="color: ${u?"green":"red"}">${u?"ENABLED":"DISABLED"}</strong><br>
        Slides Detected: <strong>${c}</strong><br>
        Connection Status: <span style="color:${C?"green":"red"};font-weight:bold;">${C?"Connected":"Disconnected"}</span><br>
        Last Action: <span style="font-family: monospace;">${t}</span><br>
        ${l}
        <details><summary>First Slide Preview</summary><pre>${d}</pre></details>
    `}async function v(e=[],t="none"){const n=document.getElementById("debug-info");if(!n)return;const a=p.isFeatureEnabled("authentication"),i=p.isFeatureEnabled("debugMode");let o=!1,s="";if(a)try{o=await b.isAuthenticated();const u=await b.getCurrentUser();s=(u==null?void 0:u.email)||""}catch{}n.innerHTML=ee(e,t,{authFeatureEnabled:a,isAuthenticated:o,userEmail:s,debugMode:i});const c=document.getElementById("debug-login-btn");c&&c.addEventListener("click",async()=>{console.log("[SIDEBAR] Debug login button clicked"),await b.login()});const d=document.getElementById("debug-logout-btn");d&&d.addEventListener("click",async()=>{console.log("[SIDEBAR] Debug logout button clicked"),await b.logout()})}function D(e){var u;r=e;const t=document.getElementById("sidebar-main");if(!t)return;const n=document.getElementById("timetable-title");n&&(n.textContent=((u=e.items[0])==null?void 0:u.title)||"Course Timetable");const a=document.getElementById("duration-badge");if(a){const l=Math.floor(e.totalDuration/60),m=e.totalDuration%60;a.textContent=`${l}h ${m}m`}const i=document.getElementById("functions-toolbar");if(!i)return;i.innerHTML="";const o=document.createElement("div");o.className="time-display-section",o.prepend(Z(e,l=>{r.startTime=l;const m=L(r);D(m),A()})),i.appendChild(o);const s=document.createElement("div");s.className="export-options",s.innerHTML=`
    <button id="export-xlsx-btn" class="export-btn"><img src="/assets/xlsx.svg" alt="Excel">Excel</button>
    <button id="auth-login-toolbar-btn" class="export-btn"><span>üîê</span><span id="auth-toolbar-text">Login</span></button>
  `,i.appendChild(s),t.innerHTML="",s.querySelector("#export-xlsx-btn").onclick=()=>{if(!r)return;const l=P(r),m=`gamma-timetable-${new Date().toISOString().slice(0,10)}.xlsx`,f=URL.createObjectURL(l);z(m,f,!0)};const c=s.querySelector("#auth-login-toolbar-btn"),d=s.querySelector("#auth-toolbar-text");if(c&&d){const l=async()=>{await b.isAuthenticated()?(d.textContent="Logout",c.onclick=async()=>{console.log("[SIDEBAR] Toolbar logout button clicked"),await b.logout(),await l()}):(d.textContent="Login",c.onclick=async()=>{var f;console.log("[SIDEBAR] Toolbar login button clicked (web-first pairing)");try{const h=p.getConfig(),k=h.environment.apiBaseUrl||"http://localhost:3000",H=h.environment.webBaseUrl||"http://localhost:3000",x=await E.registerDevice(k),R=E.buildSignInUrl(H,x.code);(f=chrome==null?void 0:chrome.tabs)!=null&&f.create?chrome.tabs.create({url:R}):window!=null&&window.open&&window.open(R,"_blank"),await E.pollExchangeUntilLinked(k,x.deviceId,x.code)?(console.log("[SIDEBAR] Device linked; token stored."),await l()):console.warn("[SIDEBAR] Device linking timed out.")}catch(h){console.error("[SIDEBAR] Web-first login failed:",h)}})};l()}e.items.forEach(l=>{const m=document.createElement("div");m.className="slide-item";const f=Y(l.content);m.innerHTML=`
      <div class="slide-item-header">
        <h3 class="slide-item__title">${l.title}</h3>
        <div class="slide-item-time">
          ${l.startTime} - ${l.endTime}
        </div>
      </div>
      <div class="duration-slider-container">
        <input type="range" min="0" max="60" value="${l.duration}" class="duration-slider" data-slide-id="${l.id}">
        <span class="duration-display">${parseInt(l.duration,10)} min</span>
      </div>
      <div class="slide-item-content">${f}</div>
    `,t.appendChild(m)}),t.querySelectorAll(".duration-slider").forEach(l=>{l.addEventListener("input",te),l.addEventListener("change",ne)})}const A=M(async()=>{var e;if(r&&S){const t=`timetable-${S}`;try{const n=p.getConfig(),a=n.environment.apiBaseUrl;n.features.cloudSync&&a?(await _(t,r,{deviceAuth:E,apiBaseUrl:a,title:r.title||((e=I[0])==null?void 0:e.title)||"Untitled Presentation",enableAutoSync:!0}),console.log("[SIDEBAR] Timetable saved with cloud sync.")):(await B(t,r),console.log("[SIDEBAR] Timetable saved (local only)."))}catch(n){console.error("[SIDEBAR] Save failed:",n);try{await B(t,r),console.log("[SIDEBAR] Timetable saved (fallback to local).")}catch(a){console.error("[SIDEBAR] Fallback save also failed:",a)}}}},500);function te(e){const t=parseInt(e.target.value,10),n=e.target.nextElementSibling;n&&(n.textContent=`${t} min`)}function ne(e){const t=e.target.getAttribute("data-slide-id"),n=parseInt(e.target.value,10),a=r.items.find(o=>o.id===t);if(a){a.duration=n;const o=L(r);D(o),A()}const i=e.target.nextElementSibling;i&&(i.textContent=`${n} min`)}function L(e){const t=new Date(`1970-01-01T${e.startTime}:00`);let n=0;const a=e.items.map(i=>{const o=new Date(t),s=i.duration;t.setMinutes(t.getMinutes()+s);const c=new Date(t);return n+=s,{...i,startTime:o.toTimeString().slice(0,5),endTime:c.toTimeString().slice(0,5)}});return{...e,items:a,totalDuration:n}}document.addEventListener("DOMContentLoaded",async()=>{console.log("[SIDEBAR] DOMContentLoaded fired"),await oe(),Q()});async function oe(){try{console.log("[SIDEBAR] Initializing infrastructure..."),await p.initialize(),G=!0,console.log("[SIDEBAR] ConfigManager initialized"),await b.initialize(),j=!0,console.log("[SIDEBAR] AuthManager initialized"),console.log("[SIDEBAR] Clerk key present at build:",!0),await ae(),ie(),v([],"Infrastructure ready"),console.log("[SIDEBAR] Infrastructure ready")}catch(e){console.error("[SIDEBAR] Failed to initialize infrastructure:",e),console.log("[SIDEBAR] Continuing in fallback mode...")}}async function ae(){await U(),await N()}async function U(){const e=document.getElementById("auth-status-bar");if(!e)return;if(!(await p.getConfig()).features.authentication){e.style.display="none";return}e.style.display="none"}function ie(){b.addEventListener(async e=>{console.log("[SIDEBAR] Auth state changed:",e.type),await U(),await N(),v(I,`Auth event: ${e.type}`)})}async function N(){const e=document.getElementById("cloud-sync-section");if(!e)return;const t=p.getConfig();if(!(t.features.cloudSync&&t.environment.apiBaseUrl)){e.style.display="none";return}try{if(await b.isAuthenticated()){e.style.display="block";const i=document.getElementById("save-to-cloud-btn"),o=document.getElementById("load-from-cloud-btn"),s=document.getElementById("auto-sync-toggle");i&&(i.disabled=!1),o&&(o.disabled=!1),s&&(s.disabled=!1),se(),await de()}else e.style.display="none"}catch(a){console.warn("[SIDEBAR] Failed to check auth state for sync controls:",a),e.style.display="none"}}function se(){const e=document.getElementById("save-to-cloud-btn"),t=document.getElementById("load-from-cloud-btn"),n=document.getElementById("auto-sync-toggle");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",ce),e.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("click",le),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",re),n.dataset.listenerAttached="true")}async function ce(){var n,a;if(!r||!S){g("No presentation data to save","error");return}const e=document.getElementById("save-to-cloud-btn"),t=(n=e==null?void 0:e.querySelector(".sync-btn-text"))==null?void 0:n.textContent;try{if(g("Saving to cloud...","info"),y("syncing"),e){e.disabled=!0;const c=e.querySelector(".sync-btn-text");c&&(c.textContent="Saving...")}const o=p.getConfig().environment.apiBaseUrl,s=await T.syncToCloud(S,r,{apiBaseUrl:o,deviceAuth:E,title:r.title||((a=I[0])==null?void 0:a.title)||"Untitled Presentation"});if(s.success)g("Successfully saved to cloud!","success"),y("synced"),F(),console.log("[SIDEBAR] Manual save to cloud successful");else throw new Error(s.error||"Failed to save to cloud")}catch(i){console.error("[SIDEBAR] Manual save to cloud failed:",i),g(`Save failed: ${i.message}`,"error"),y("error")}finally{if(e){e.disabled=!1;const i=e.querySelector(".sync-btn-text");i&&t&&(i.textContent=t)}}}async function le(){var n;if(!S){g("No presentation to load","error");return}const e=document.getElementById("load-from-cloud-btn"),t=(n=e==null?void 0:e.querySelector(".sync-btn-text"))==null?void 0:n.textContent;try{if(g("Loading from cloud...","info"),y("syncing"),e){e.disabled=!0;const s=e.querySelector(".sync-btn-text");s&&(s.textContent="Loading...")}const i=p.getConfig().environment.apiBaseUrl,o=await T.syncFromCloud(S,{apiBaseUrl:i,deviceAuth:E});if(o.success&&o.data){const s=o.data;if(r&&r.lastModified&&s.lastModified&&new Date(r.lastModified)>new Date(s.lastModified)&&!await ue(r,s)){g("Load cancelled - keeping local version","info"),y("synced");return}r=s;const d=`timetable-${S}`;await B(d,s),D(s),g("Successfully loaded from cloud!","success"),y("synced"),F(),console.log("[SIDEBAR] Manual load from cloud successful")}else if(o.error==="Presentation not found in cloud")g("No cloud version found for this presentation","info"),y("synced");else throw new Error(o.error||"Failed to load from cloud")}catch(a){console.error("[SIDEBAR] Manual load from cloud failed:",a),g(`Load failed: ${a.message}`,"error"),y("error")}finally{if(e){e.disabled=!1;const a=e.querySelector(".sync-btn-text");a&&t&&(a.textContent=t)}}}async function re(){const e=document.getElementById("auto-sync-toggle"),t=e==null?void 0:e.querySelector(".sync-btn-text"),n=e==null?void 0:e.classList.contains("active");n?(e.classList.remove("active"),t&&(t.textContent="Auto Sync: Off"),g("Auto-sync disabled","info")):(e.classList.add("active"),t&&(t.textContent="Auto Sync: On"),g("Auto-sync enabled","success")),console.log("[SIDEBAR] Auto-sync toggled:",!n)}function g(e,t="info"){let n=document.getElementById("sync-status-message");if(!n){n=document.createElement("div"),n.id="sync-status-message",n.className="sync-status-message";const a=document.getElementById("cloud-sync-section");a&&a.appendChild(n)}n.textContent=e,n.className=`sync-status-message ${t}`,n.style.display="block",(t==="success"||t==="info")&&setTimeout(()=>{n&&(n.style.display="none")},3e3)}function y(e){const t=document.getElementById("sync-indicator");if(t)switch(t.className="sync-indicator",t.classList.add(e),e){case"synced":t.textContent="‚óè";break;case"syncing":t.textContent="‚ü≥";break;case"error":t.textContent="‚ö†";break;case"offline":t.textContent="‚óã";break;default:t.textContent="‚óè"}}function F(){const e=document.getElementById("last-sync-time");if(e){const n=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});e.textContent=`Last sync: ${n}`}}async function de(){try{const e=await b.isAuthenticated();y(e?"synced":"offline")}catch{y("error")}}async function ue(e,t){return new Promise(n=>{const a=new Date(e.lastModified||0).toLocaleString(),i=new Date(t.lastModified||0).toLocaleString(),o=`Conflict detected:

Local version: ${a}
Cloud version: ${i}

Which version would you like to keep?`,s=confirm(`${o}

Click OK to use cloud version
Click Cancel to keep local version`);n(s)})}
