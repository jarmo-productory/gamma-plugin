console.log("[BACKGROUND] Script loaded");const i={};let s=null,t=null;chrome.runtime.onConnect.addListener(e=>{var n,r;if(console.log("[BACKGROUND] New connection:",e.name,"from:",e.sender),e.name==="content-script"){const o=(r=(n=e.sender)==null?void 0:n.tab)==null?void 0:r.id;o&&(i[o]=e,console.log(`[BACKGROUND] Content script connected for tab ${o}.`),e.onDisconnect.addListener(()=>{delete i[o],console.log(`[BACKGROUND] Content script for tab ${o} disconnected.`)}),e.onMessage.addListener(a=>{s&&(o===t?(console.log(`[BACKGROUND] Forwarding message from active content script (tab ${o}) to sidebar:`,a),s.postMessage({...a,tabId:o})):console.log(`[BACKGROUND] Ignoring message from inactive tab ${o}.`))}))}else e.name==="sidebar"&&(s=e,console.log("[BACKGROUND] Sidebar connected."),s.onDisconnect.addListener(()=>{s=null,console.log("[BACKGROUND] Sidebar disconnected.")}),s.onMessage.addListener(o=>{if(console.log("[BACKGROUND] Message from sidebar:",o),o.type==="get-slides"&&t){const a=i[t];a?(console.log(`[BACKGROUND] Forwarding get-slides to content script for active tab ${t}.`),a.postMessage(o)):(console.log(`[BACKGROUND] No content script for active tab ${t}.`),s.postMessage({type:"error",message:"No content script connected for the active Gamma tab. Please refresh the page."}))}}),t&&c(t))});function c(e){if(!s){console.log("[BACKGROUND] No sidebar to update.");return}chrome.tabs.get(e,n=>{if(chrome.runtime.lastError){console.error(`[BACKGROUND] Error getting tab info: ${chrome.runtime.lastError.message}`),s.postMessage({type:"show-message",message:"Error accessing tab."});return}n&&n.url&&n.url.startsWith("https://gamma.app/")?(console.log(`[BACKGROUND] Active tab is a Gamma tab: ${e}`),s.postMessage({type:"gamma-tab-activated",tabId:e})):(console.log(`[BACKGROUND] Active tab is not a Gamma tab: ${e}`),s.postMessage({type:"show-message",message:"This extension only works with presentations on Gamma.app."}))})}chrome.tabs.onActivated.addListener(e=>{console.log(`[BACKGROUND] Tab activated: ${e.tabId}`),t=e.tabId,c(t)});chrome.runtime.onInstalled.addListener(()=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{e.length>0&&(t=e[0].id,console.log(`[BACKGROUND] Extension installed/updated. Initial active tab: ${t}`))})});setInterval(()=>{if(t&&s){console.log(`[BACKGROUND] Heartbeat: Requesting slide update from active tab ${t}`);const e=i[t];e&&e.postMessage({type:"get-slides"})}},5e3);
