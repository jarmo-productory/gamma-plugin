console.log("[BACKGROUND] Script loaded");const t={},a={};let l=null;const c=new Set;chrome.runtime.onConnect.addListener(n=>{var r,g,b,f,C,D,G;if(console.log("[BACKGROUND] New connection:",n.name,"from:",n.sender),console.log("[BACKGROUND] Port sender details:",{tab:(r=n.sender)==null?void 0:r.tab,tabId:(b=(g=n.sender)==null?void 0:g.tab)==null?void 0:b.id,url:(f=n.sender)==null?void 0:f.url,frameId:(C=n.sender)==null?void 0:C.frameId}),(G=(D=n.sender)==null?void 0:D.tab)!=null&&G.id){const e=String(n.sender.tab.id);n.name==="content-script"&&(t[e]=n,l=e,console.log(`[BACKGROUND] Content script connected for tab ${e}.`),console.log("[BACKGROUND] Current content script ports:",Object.keys(t)),a[e]&&c.has(e)&&(console.log(`[BACKGROUND] Found waiting sidebar for tab ${e}, requesting slides...`),n.postMessage({type:"get-slides"}),c.delete(e)),n.onDisconnect.addListener(()=>{delete t[e],console.log(`[BACKGROUND] Content script for tab ${e} disconnected.`)}),n.onMessage.addListener(s=>{var i;console.log(`[BACKGROUND] Message from content script (tab ${e}):`,s);const o=a[e];o&&s.type==="slide-data"?(console.log(`[BACKGROUND] Forwarding slide-data to sidebar for tab ${e}. Slides:`,((i=s.slides)==null?void 0:i.length)||0),o.postMessage(s)):o||console.log(`[BACKGROUND] No sidebar port found for tab ${e}`)}))}else if(n.name==="sidebar"){console.log("[BACKGROUND] Sidebar connection initiated"),console.log("[BACKGROUND] Available content script ports:",Object.keys(t)),console.log("[BACKGROUND] Last Gamma tab ID:",l);let e=null;if(l&&t[l])e=l,console.log("[BACKGROUND] Using last Gamma tab ID:",e);else{const s=Object.keys(t);s.length>0&&(e=s[0],console.log("[BACKGROUND] Using first available tab:",e))}if(e)console.log(`[BACKGROUND] Connecting sidebar to tab ${e}`),a[e]=n,n.onDisconnect.addListener(()=>{delete a[e],c.delete(e),console.log(`[BACKGROUND] Sidebar for tab ${e} disconnected.`)}),n.onMessage.addListener(s=>{if(console.log(`[BACKGROUND] Message from sidebar for tab ${e}:`,s),s.type==="get-slides"){const o=t[e];o?(console.log(`[BACKGROUND] Forwarding get-slides request to content script for tab ${e}.`),o.postMessage(s)):(console.log(`[BACKGROUND] Content script not yet connected for tab ${e}, marking as pending...`),c.add(e))}});else{console.log("[BACKGROUND] No content scripts connected yet, waiting..."),console.log("[BACKGROUND] contentScriptPorts object:",t);const s="pending_"+Date.now();a[s]=n,n.onDisconnect.addListener(()=>{delete a[s],console.log("[BACKGROUND] Pending sidebar disconnected.")}),n.onMessage.addListener(o=>{if(o.type==="get-slides"){console.log("[BACKGROUND] Sidebar requesting slides but no content scripts available yet");const i=Object.keys(t);if(i.length>0){const d=i[0];delete a[s],a[d]=n,console.log(`[BACKGROUND] Found content script for tab ${d}, forwarding request`),t[d].postMessage(o)}else n.postMessage({type:"error",message:"No Gamma tabs found. Please refresh the Gamma presentation page."})}})}}});
