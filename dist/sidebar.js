import"./assets/modulepreload-polyfill.js";function S(e,t={}){const{startTime:n="09:00",defaultDuration:o=5,breakAfter:s=60,breakDuration:a=10,existingItems:l=[]}=t;let r=new Date(`1970-01-01T${n}:00`),g=0;const m=e.map(u=>{const p=l.find(I=>I.id===u.id),i=p?p.duration:u.duration===0?0:u.duration||o,c=new Date(r);r.setMinutes(r.getMinutes()+i);const f=new Date(r);return g+=i,{id:u.id,title:u.title,content:u.content,startTime:c.toTimeString().slice(0,5),endTime:f.toTimeString().slice(0,5),duration:i}});return{startTime:n,items:m,totalDuration:g}}function x(e){let t=`Item,Start Time,Duration (min),End Time
`;return e.items.forEach(n=>{const o=n.title.replace(/"/g,'""');t+=`"${o}",${n.startTime},${n.duration},${n.endTime}
`}),t}function C(e,t,n=!1){const o=document.createElement("a");if(o.setAttribute("download",e),o.style.visibility="hidden",document.body.appendChild(o),n)o.href=t;else{const s=new Blob([t],{type:"text/csv;charset=utf-8;"});o.href=URL.createObjectURL(s)}o.click(),document.body.removeChild(o)}function w(e){var l;const t=e.items.map(({id:r,...g})=>g),n=((l=e.items[0])==null?void 0:l.title)||"Course Timetable",o=XLSX.utils.json_to_sheet(t);if(XLSX.utils.sheet_add_aoa(o,[[n]],{origin:"A1"}),XLSX.utils.sheet_add_aoa(o,[[]],{origin:"A2"}),o["!ref"]){const r=XLSX.utils.decode_range(o["!ref"]);r.s.r+=2,r.e.r+=2,o["!ref"]=XLSX.utils.encode_range(r)}const s=XLSX.utils.book_new();XLSX.utils.book_append_sheet(s,o,"Timetable");const a=XLSX.write(s,{bookType:"xlsx",type:"array"});return new Blob([a],{type:"application/octet-stream"})}function $(e){return navigator.clipboard.writeText(e)}function E(e,t){return new Promise((n,o)=>{chrome.storage.local.set({[e]:t},()=>{if(chrome.runtime.lastError)return o(chrome.runtime.lastError);n()})})}function k(e){return new Promise((t,n)=>{chrome.storage.local.get(e,o=>{if(chrome.runtime.lastError)return n(chrome.runtime.lastError);t(o[e])})})}function L(e,t){let n;return function(...o){const s=this;clearTimeout(n),n=setTimeout(()=>e.apply(s,o),t)}}console.log("[SIDEBAR] Script loaded");const B="0.0.2";let y=!1,D=[],d=null,b=null;const R=async e=>{console.log("[SIDEBAR] updateUIWithNewSlides called with",(e==null?void 0:e.length)||0,"slides");const t=document.getElementById("sidebar-footer");if(D=e||[],e.length===0){document.getElementById("sidebar-main").innerHTML="<p>No slides detected in this Gamma presentation.</p>",t&&(t.innerHTML=h(e,"Received: slide-data (empty)"));return}const n=await v(),o=await k(n),s=S(e,{startTime:(o==null?void 0:o.startTime)||"09:00",existingItems:(o==null?void 0:o.items)||[]});T(s),E(n,s),t&&(t.innerHTML=h(e,"Rendered: slide-data"))};function X(){if(console.log("[SIDEBAR] Connecting to background script..."),b=chrome.runtime.connect({name:"sidebar"}),console.log("[SIDEBAR] Connected to background"),!b){console.error("[SIDEBAR] Failed to create port connection");return}y=!0;const e=document.getElementById("sidebar-footer");e&&(e.innerHTML=h([],"Connected to background")),setTimeout(()=>{console.log("[SIDEBAR] Sending get-slides request..."),b&&(b.postMessage({type:"get-slides"}),e&&(e.innerHTML=h([],"Sent: get-slides")))},100),b.onMessage.addListener(t=>{var n;if(console.log("[SIDEBAR] Received message from background:",t),t.type==="slide-data")console.log("[SIDEBAR] Received slide-data from background:",((n=t.slides)==null?void 0:n.length)||0,"slides"),R(t.slides);else if(t.type==="error"){console.error("[SIDEBAR] Error from background:",t.message),document.getElementById("sidebar-main").innerHTML=`<p style="color: red;">${t.message}</p>`;const o=document.getElementById("sidebar-footer");o&&(o.innerHTML=h([],"Error: "+t.message))}}),b.onDisconnect.addListener(()=>{b=null,y=!1,console.log("[SIDEBAR] Disconnected from background script.");const t=document.getElementById("sidebar-footer");t&&(t.innerHTML=h([],"Disconnected"))})}async function M(){try{return await new Promise((e,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},n=>{if(chrome.runtime.lastError)return t(new Error(chrome.runtime.lastError.message));n[0]&&n[0].url?e(n[0].url):(console.warn("Could not get current tab URL. Falling back to default."),e("default-timetable"))})})}catch(e){return console.error("Error getting current tab URL:",e),"default-timetable"}}async function v(){return`timetable-${await M()}`}function A(e){let t="";return e.forEach(n=>{switch(n.type){case"paragraph":t+=`<p>${n.text}</p>`;break;case"image":t+=`<img src="${n.text}" class="thumbnail-img">`;break;case"link":t+=`<a href="${n.text}" target="_blank" class="content-link">${n.text}</a>`;break;case"list_item":t+=`<p>${n.text}</p>`,n.subItems&&n.subItems.length>0&&(t+='<ul class="sub-items-list">',n.subItems.forEach(o=>{t+=`<li class="sub-item">${o}</li>`}),t+="</ul>");break}}),t}function H(e,t){const n=document.createElement("div");n.className="time-input-container";const[o,s]=e.startTime.split(":"),a=document.createElement("input");a.type="text",a.className="time-input-segment",a.value=o,a.maxLength=2,a.placeholder="00";const l=document.createElement("span");l.className="time-input-separator",l.textContent=":";const r=document.createElement("input");r.type="text",r.className="time-input-segment",r.value=s,r.maxLength=2,r.placeholder="00";const m=L(()=>{const u=a.value.padStart(2,"0"),p=r.value.padStart(2,"0"),i=parseInt(u,10),c=parseInt(p,10);i>=0&&i<=23&&c>=0&&c<=59&&t(`${u}:${p}`)},400);return a.addEventListener("input",()=>{a.value.length>=2&&(a.value=a.value.slice(0,2),r.focus()),m()}),r.addEventListener("input",()=>{r.value.length>=2&&(r.value=r.value.slice(0,2)),m()}),n.appendChild(a),n.appendChild(l),n.appendChild(r),n}function h(e=[],t="none"){const n=e.length;let o=e[0]?JSON.stringify(e[0],null,2):"N/A";return`
    <div class="debug-info">
      <strong>Debug Info</strong><br>
      Slides Detected: <strong>${n}</strong><br>
      Connection Status: <span style="color:${y?"green":"red"};font-weight:bold;">${y?"Connected":"Disconnected"}</span><br>
      Last Action: <span style="font-family: monospace;">${t}</span><br>
      <details><summary>First Slide Preview</summary><pre>${o}</pre></details>
    </div>
  `}function T(e){var p;d=e;const t=document.getElementById("sidebar-main");if(!t)return;const n=document.getElementById("timetable-title");n&&(n.textContent=((p=e.items[0])==null?void 0:p.title)||"Course Timetable");const o=document.getElementById("duration-badge");if(o){const i=Math.floor(e.totalDuration/60),c=e.totalDuration%60;o.textContent=`${i}h ${c}m`}const s=document.getElementById("functions-toolbar");if(!s)return;s.innerHTML="";const a=document.createElement("div");a.className="time-display-section",a.prepend(H(e,i=>{const c=S(D,{startTime:i,existingItems:(d==null?void 0:d.items)||[]});T(c),v().then(f=>E(f,c))})),s.appendChild(a);const l=document.createElement("div");l.className="export-options",l.innerHTML=`
    <button id="export-csv-btn" class="export-btn"><img src="/assets/csv.svg" alt="CSV">CSV</button>
    <button id="export-xlsx-btn" class="export-btn"><img src="/assets/xlsx.svg" alt="Excel">Excel</button>
    <button id="copy-clipboard-btn" class="export-btn copy-btn-icon-only"><img src="/assets/copy.svg" alt="Copy"></button>
  `,s.appendChild(l),t.innerHTML="";const r=l.querySelector("#export-csv-btn");r.onclick=()=>{if(!d)return;const i=x(d),c=`gamma-timetable-${new Date().toISOString().slice(0,10)}.csv`;C(c,i)};const g=l.querySelector("#export-xlsx-btn");g.onclick=()=>{if(!d)return;const i=w(d),c=`gamma-timetable-${new Date().toISOString().slice(0,10)}.xlsx`,f=URL.createObjectURL(i);C(c,f,!0)};const m=l.querySelector("#copy-clipboard-btn");m.onclick=()=>{if(!d)return;const i=x(d);$(i).then(()=>{m.classList.add("copied"),setTimeout(()=>{m.classList.remove("copied")},2e3)})},e.items.forEach(i=>{const c=document.createElement("div");c.className="slide-item";const f=A(i.content);c.innerHTML=`
      <div class="slide-item-header">
        <h3 class="slide-item__title">${i.title}</h3>
        <div class="slide-item-time">
          ${i.startTime} - ${i.endTime}
        </div>
      </div>
      <div class="duration-slider-container">
        <input type="range" min="0" max="60" value="${i.duration}" class="duration-slider" data-slide-id="${i.id}">
        <span class="duration-display">${parseInt(i.duration,10)} min</span>
      </div>
      <div class="slide-item-content">${f}</div>
    `,t.appendChild(c)}),t.querySelectorAll(".duration-slider").forEach(i=>{i.addEventListener("input",N),i.addEventListener("change",O)})}const _=L(async()=>{if(d){const e=await v();E(e,d),console.log("Timetable saved.")}},500);function N(e){const t=parseInt(e.target.value,10),n=e.target.nextElementSibling;n&&(n.textContent=`${t} min`)}function O(e){const t=e.target.getAttribute("data-slide-id"),n=parseInt(e.target.value,10),o=d.items.find(a=>a.id===t);if(o){o.duration=n;const a=S(d.items,{startTime:d.startTime});T(a),_()}const s=e.target.nextElementSibling;s&&(s.textContent=`${n} min`)}document.addEventListener("DOMContentLoaded",async()=>{console.log("[SIDEBAR] DOMContentLoaded fired");const e=document.getElementById("version-display");e&&(e.textContent=`v${B}`),X()});
