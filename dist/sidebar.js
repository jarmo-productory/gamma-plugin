import"./assets/modulepreload-polyfill.js";function f(e,t={}){const{startTime:n="09:00",defaultDuration:o=5,breakAfter:i=60,breakDuration:l=10,existingItems:g=[]}=t;let u=new Date(`1970-01-01T${n}:00`),m=0;const E=e.map(r=>{const a=g.find(w=>w.id===r.id),c=a?a.duration:r.duration===0?0:r.duration||o,D=new Date(u);u.setMinutes(u.getMinutes()+c);const C=new Date(u);return m+=c,{id:r.id,title:r.title,content:r.content,startTime:D.toTimeString().slice(0,5),endTime:C.toTimeString().slice(0,5),duration:c}});return{startTime:n,items:E,totalDuration:m}}function S(e){let t=`Item,Start Time,Duration (min),End Time
`;return e.items.forEach(n=>{const o=n.title.replace(/"/g,'""');t+=`"${o}",${n.startTime},${n.duration},${n.endTime}
`}),t}function v(e,t,n=!1){const o=document.createElement("a");if(o.setAttribute("download",e),o.style.visibility="hidden",document.body.appendChild(o),n)o.href=t;else{const i=new Blob([t],{type:"text/csv;charset=utf-8;"});o.href=URL.createObjectURL(i)}o.click(),document.body.removeChild(o)}function L(e){const t=XLSX.utils.json_to_sheet(e.items),n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,t,"Timetable");const o=XLSX.write(n,{bookType:"xlsx",type:"array"});return new Blob([o],{type:"application/octet-stream"})}function k(e){return navigator.clipboard.writeText(e)}function h(e,t){return new Promise((n,o)=>{chrome.storage.local.set({[e]:t},()=>{if(chrome.runtime.lastError)return o(chrome.runtime.lastError);n()})})}function $(e){return new Promise((t,n)=>{chrome.storage.local.get(e,o=>{if(chrome.runtime.lastError)return n(chrome.runtime.lastError);t(o[e])})})}function B(e,t){let n;return function(...o){const i=this;clearTimeout(n),n=setTimeout(()=>e.apply(i,o),t)}}console.log("[SIDEBAR] Script loaded");const I="0.0.2";let b=!1,x=[],s=null,d=null;const R=async e=>{console.log("[SIDEBAR] updateUIWithNewSlides called with",(e==null?void 0:e.length)||0,"slides");const t=document.getElementById("sidebar-footer");if(x=e||[],e.length===0){document.getElementById("sidebar-main").innerHTML="<p>No slides detected in this Gamma presentation.</p>",t&&(t.innerHTML=p(e,"Received: slide-data (empty)"));return}const n=await y(),o=await $(n),i=f(e,{startTime:(o==null?void 0:o.startTime)||"09:00",existingItems:(o==null?void 0:o.items)||[]});T(i),h(n,i),t&&(t.innerHTML=p(e,"Rendered: slide-data"))};function M(){if(console.log("[SIDEBAR] Connecting to background script..."),d=chrome.runtime.connect({name:"sidebar"}),console.log("[SIDEBAR] Connected to background"),!d){console.error("[SIDEBAR] Failed to create port connection");return}b=!0;const e=document.getElementById("sidebar-footer");e&&(e.innerHTML=p([],"Connected to background")),setTimeout(()=>{console.log("[SIDEBAR] Sending get-slides request..."),d&&(d.postMessage({type:"get-slides"}),e&&(e.innerHTML=p([],"Sent: get-slides")))},100),d.onMessage.addListener(t=>{var n;if(console.log("[SIDEBAR] Received message from background:",t),t.type==="slide-data")console.log("[SIDEBAR] Received slide-data from background:",((n=t.slides)==null?void 0:n.length)||0,"slides"),R(t.slides);else if(t.type==="error"){console.error("[SIDEBAR] Error from background:",t.message),document.getElementById("sidebar-main").innerHTML=`<p style="color: red;">${t.message}</p>`;const o=document.getElementById("sidebar-footer");o&&(o.innerHTML=p([],"Error: "+t.message))}}),d.onDisconnect.addListener(()=>{d=null,b=!1,console.log("[SIDEBAR] Disconnected from background script.");const t=document.getElementById("sidebar-footer");t&&(t.innerHTML=p([],"Disconnected"))})}async function A(){try{return await new Promise((e,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},n=>{if(chrome.runtime.lastError)return t(new Error(chrome.runtime.lastError.message));n[0]&&n[0].url?e(n[0].url):(console.warn("Could not get current tab URL. Falling back to default."),e("default-timetable"))})})}catch(e){return console.error("Error getting current tab URL:",e),"default-timetable"}}async function y(){return`timetable-${await A()}`}function H(e){let t="";return e.forEach(n=>{switch(n.type){case"paragraph":t+=`<p>${n.text}</p>`;break;case"image":t+=`<img src="${n.text}" class="thumbnail-img">`;break;case"link":t+=`<a href="${n.text}" target="_blank" class="content-link">${n.text}</a>`;break;case"list_item":t+=`<p>${n.text}</p>`,n.subItems&&n.subItems.length>0&&(t+='<ul class="sub-items-list">',n.subItems.forEach(o=>{t+=`<li class="sub-item">${o}</li>`}),t+="</ul>");break}}),t}function p(e=[],t="none"){const n=e.length;let o=e[0]?JSON.stringify(e[0],null,2):"N/A";return`
    <div class="debug-info">
      <strong>Debug Info</strong><br>
      Slides Detected: <strong>${n}</strong><br>
      Connection Status: <span style="color:${b?"green":"red"};font-weight:bold;">${b?"Connected":"Disconnected"}</span><br>
      Last Action: <span style="font-family: monospace;">${t}</span><br>
      <details><summary>First Slide Preview</summary><pre>${o}</pre></details>
    </div>
  `}function T(e){s=e;const t=document.getElementById("sidebar-main");if(!t)return;const n=document.createElement("h3");n.innerHTML=`Timetable (Total: ${e.totalDuration} mins)`;const o=document.createElement("div");o.className="sticky-toolbar";const i=document.createElement("button");i.className="btn",i.textContent="Regenerate Timetable",i.onclick=()=>{const r=prompt("Enter start time (e.g., 09:00):","09:00");if(r){const a=f(x,{startTime:r});T(a),y().then(c=>h(c,a))}},o.appendChild(i);const l=document.createElement("div");l.className="export-options",l.innerHTML=`
    <button id="export-csv-btn" class="export-btn">CSV</button>
    <button id="export-xlsx-btn" class="export-btn">Excel</button>
    <button id="copy-clipboard-btn" class="export-btn">Copy</button>
  `,o.appendChild(l),t.innerHTML="",t.appendChild(n),t.appendChild(o);const g=l.querySelector("#export-csv-btn");g.onclick=()=>{if(!s)return;const r=S(s),a=`gamma-timetable-${new Date().toISOString().slice(0,10)}.csv`;v(a,r)};const u=l.querySelector("#export-xlsx-btn");u.onclick=()=>{if(!s)return;const r=L(s),a=`gamma-timetable-${new Date().toISOString().slice(0,10)}.xlsx`,c=URL.createObjectURL(r);v(a,c,!0)};const m=l.querySelector("#copy-clipboard-btn");m.onclick=()=>{if(!s)return;const r=S(s);k(r).then(()=>{m.textContent="Copied!",setTimeout(()=>{m.textContent="Copy"},2e3)})},e.items.forEach(r=>{const a=document.createElement("div");a.className="slide-item";const c=H(r.content);a.innerHTML=`
      <div class="slide-item-header">
        <h3 class="slide-item__title">${r.title}</h3>
        <div class="slide-item-time">
          <span style="font-size: 12px; color: #6b7280;">${r.startTime} - ${r.endTime}</span>
        </div>
      </div>
      <div class="duration-slider-container">
          <input type="range" min="0.5" max="30" value="${r.duration}" step="0.5" class="duration-slider" data-id="${r.id}">
          <span class="duration-value">${r.duration} min</span>
      </div>
      <div class="slide-item__content">
        ${c}
      </div>
    `,t.appendChild(a)}),t.querySelectorAll(".duration-slider").forEach(r=>{r.addEventListener("input",_),r.addEventListener("change",N)})}const X=B(async()=>{if(s){const e=await y();h(e,s),console.log("Timetable saved.")}},500);function _(e){const t=parseFloat(e.target.value).toFixed(1),n=e.target.nextElementSibling;n&&(n.textContent=`${t} min`)}function N(e){const t=e.target.getAttribute("data-id"),n=parseFloat(e.target.value);if(s){const o=s.items.find(i=>i.id===t);if(o){o.duration=n;const i=f(s.items,{startTime:s.startTime});T(i),X()}}}document.addEventListener("DOMContentLoaded",async()=>{console.log("[SIDEBAR] DOMContentLoaded fired");const e=document.getElementById("version-display");e&&(e.textContent=`v${I}`),M()});
