import"./assets/modulepreload-polyfill.js";function x(t,e={}){const{startTime:n="09:00",defaultDuration:o=5,breakAfter:i=60,breakDuration:a=10,existingItems:c=[]}=e;let r=new Date(`1970-01-01T${n}:00`),g=0;const u=t.map(m=>{const p=c.find(C=>C.id===m.id),s=p?p.duration:o,d=new Date(r);r.setMinutes(r.getMinutes()+s);const f=new Date(r);return g+=s,{id:m.id,title:m.title,content:m.content,startTime:d.toTimeString().slice(0,5),endTime:f.toTimeString().slice(0,5),duration:s}});return{startTime:n,items:u,totalDuration:g}}function I(t){let e=`Item,Start Time,Duration (min),End Time
`;return t.items.forEach(n=>{const o=n.title.replace(/"/g,'""');e+=`"${o}",${n.startTime},${n.duration},${n.endTime}
`}),e}function D(t,e,n=!1){const o=document.createElement("a");if(o.setAttribute("download",t),o.style.visibility="hidden",document.body.appendChild(o),n)o.href=e;else{const i=new Blob([e],{type:"text/csv;charset=utf-8;"});o.href=URL.createObjectURL(i)}o.click(),document.body.removeChild(o)}function L(t){var c;const e=t.items.map(({id:r,...g})=>g),n=((c=t.items[0])==null?void 0:c.title)||"Course Timetable",o=XLSX.utils.json_to_sheet(e);if(XLSX.utils.sheet_add_aoa(o,[[n]],{origin:"A1"}),XLSX.utils.sheet_add_aoa(o,[[]],{origin:"A2"}),o["!ref"]){const r=XLSX.utils.decode_range(o["!ref"]);r.s.r+=2,r.e.r+=2,o["!ref"]=XLSX.utils.encode_range(r)}const i=XLSX.utils.book_new();XLSX.utils.book_append_sheet(i,o,"Timetable");const a=XLSX.write(i,{bookType:"xlsx",type:"array"});return new Blob([a],{type:"application/octet-stream"})}function B(t){return navigator.clipboard.writeText(t)}function $(t,e){return new Promise((n,o)=>{chrome.storage.local.set({[t]:e},()=>{if(chrome.runtime.lastError)return o(chrome.runtime.lastError);n()})})}function k(t){return new Promise((e,n)=>{chrome.storage.local.get(t,o=>{if(chrome.runtime.lastError)return n(chrome.runtime.lastError);e(o[t])})})}function w(t,e){let n;return function(...o){const i=this;clearTimeout(n),n=setTimeout(()=>t.apply(i,o),e)}}console.log("[SIDEBAR] Script loaded");const R="0.0.3";let E=!1,l=null,b=null,T=null;function A(t){if(!l){console.log("[SIDEBAR] No current timetable, generating a new one.");const i=x(t);y(i),S();return}console.log("[SIDEBAR] Reconciling new slide data with existing timetable.");const e=[],n=new Map(l.items.map(i=>[i.id,i]));new Map(t.map(i=>[i.id,i]));for(const i of t){const a=n.get(i.id);a?e.push({...a,title:i.title,content:i.content}):e.push({...i,duration:5})}l.items=e;const o=v(l);y(o),S()}const M=async(t,e)=>{var i;console.log(`[SIDEBAR] updateUIWithNewSlides called for tab ${e} with`,(t==null?void 0:t.length)||0,"slides");const n=document.getElementById("sidebar-footer");if(t.length===0){document.getElementById("sidebar-main").innerHTML="<p>No slides detected in this Gamma presentation.</p>",n&&(n.innerHTML=h(t,"Received: slide-data (empty)"));return}const o=(i=t[0])==null?void 0:i.presentationUrl;if(o){if(o!==T){console.log(`[SIDEBAR] Switched to new presentation: ${o}. Loading from storage...`),T=o;const a=`timetable-${o}`,c=await k(a);c?(console.log("[SIDEBAR] Found stored timetable."),l=c):(console.log("[SIDEBAR] No stored timetable, generating a new one..."),l=x(t))}A(t),n&&(n.innerHTML=h(t,"Rendered: slide-data"))}};function X(){if(console.log("[SIDEBAR] Connecting to background script..."),b=chrome.runtime.connect({name:"sidebar"}),console.log("[SIDEBAR] Connected to background"),!b){console.error("[SIDEBAR] Failed to create port connection");return}E=!0;const t=document.getElementById("sidebar-footer");t&&(t.innerHTML=h([],"Connected to background")),b.onMessage.addListener(e=>{var n;if(console.log("[SIDEBAR] Received message from background:",e),e.type==="slide-data")console.log("[SIDEBAR] Received slide-data for tab",e.tabId,"with",((n=e.slides)==null?void 0:n.length)||0,"slides"),M(e.slides,e.tabId);else if(e.type==="gamma-tab-activated")console.log(`[SIDEBAR] Gamma tab ${e.tabId} activated. Requesting new slides.`),e.tabId,document.getElementById("sidebar-main").innerHTML="<p>Loading timetable...</p>",b.postMessage({type:"get-slides"});else if(e.type==="show-message"){console.log(`[SIDEBAR] Displaying message: ${e.message}`),document.getElementById("sidebar-main").innerHTML=`<p>${e.message}</p>`;const o=document.getElementById("timetable-title");o&&(o.textContent="Gamma Timetable");const i=document.getElementById("duration-badge");i&&(i.textContent="0h 0m")}else if(e.type==="error"){console.error("[SIDEBAR] Error from background:",e.message),document.getElementById("sidebar-main").innerHTML=`<p style="color: red;">${e.message}</p>`;const o=document.getElementById("sidebar-footer");o&&(o.innerHTML=h([],"Error: "+e.message))}}),b.onDisconnect.addListener(()=>{b=null,E=!1,console.log("[SIDEBAR] Disconnected from background script.");const e=document.getElementById("sidebar-footer");e&&(e.innerHTML=h([],"Disconnected"))})}function H(t){let e="";return t.forEach(n=>{switch(n.type){case"paragraph":e+=`<p>${n.text}</p>`;break;case"image":e+=`<img src="${n.text}" class="thumbnail-img">`;break;case"link":e+=`<a href="${n.text}" target="_blank" class="content-link">${n.text}</a>`;break;case"list_item":e+=`<p>${n.text}</p>`,n.subItems&&n.subItems.length>0&&(e+='<ul class="sub-items-list">',n.subItems.forEach(o=>{e+=`<li class="sub-item">${o}</li>`}),e+="</ul>");break}}),e}function _(t,e){const n=document.createElement("div");n.className="time-input-container";const[o,i]=t.startTime.split(":"),a=document.createElement("input");a.type="text",a.className="time-input-segment",a.value=o,a.maxLength=2,a.placeholder="00";const c=document.createElement("span");c.className="time-input-separator",c.textContent=":";const r=document.createElement("input");r.type="text",r.className="time-input-segment",r.value=i,r.maxLength=2,r.placeholder="00";const u=w(()=>{const m=a.value.padStart(2,"0"),p=r.value.padStart(2,"0"),s=parseInt(m,10),d=parseInt(p,10);s>=0&&s<=23&&d>=0&&d<=59&&e(`${m}:${p}`)},400);return a.addEventListener("input",()=>{a.value.length>=2&&(a.value=a.value.slice(0,2),r.focus()),u()}),r.addEventListener("input",()=>{r.value.length>=2&&(r.value=r.value.slice(0,2)),u()}),n.appendChild(a),n.appendChild(c),n.appendChild(r),n}function h(t=[],e="none"){const n=t.length;let o=t[0]?JSON.stringify(t[0],null,2):"N/A";return`
    <div class="debug-info">
      <strong>Debug Info</strong><br>
      Slides Detected: <strong>${n}</strong><br>
      Connection Status: <span style="color:${E?"green":"red"};font-weight:bold;">${E?"Connected":"Disconnected"}</span><br>
      Last Action: <span style="font-family: monospace;">${e}</span><br>
      <details><summary>First Slide Preview</summary><pre>${o}</pre></details>
    </div>
  `}function y(t){var p;l=t;const e=document.getElementById("sidebar-main");if(!e)return;const n=document.getElementById("timetable-title");n&&(n.textContent=((p=t.items[0])==null?void 0:p.title)||"Course Timetable");const o=document.getElementById("duration-badge");if(o){const s=Math.floor(t.totalDuration/60),d=t.totalDuration%60;o.textContent=`${s}h ${d}m`}const i=document.getElementById("functions-toolbar");if(!i)return;i.innerHTML="";const a=document.createElement("div");a.className="time-display-section",a.prepend(_(t,s=>{l.startTime=s;const d=v(l);y(d),S()})),i.appendChild(a);const c=document.createElement("div");c.className="export-options",c.innerHTML=`
    <button id="export-csv-btn" class="export-btn"><img src="/assets/csv.svg" alt="CSV">CSV</button>
    <button id="export-xlsx-btn" class="export-btn"><img src="/assets/xlsx.svg" alt="Excel">Excel</button>
    <button id="copy-clipboard-btn" class="export-btn copy-btn-icon-only"><img src="/assets/copy.svg" alt="Copy"></button>
  `,i.appendChild(c),e.innerHTML="";const r=c.querySelector("#export-csv-btn");r.onclick=()=>{if(!l)return;const s=I(l),d=`gamma-timetable-${new Date().toISOString().slice(0,10)}.csv`;D(d,s)};const g=c.querySelector("#export-xlsx-btn");g.onclick=()=>{if(!l)return;const s=L(l),d=`gamma-timetable-${new Date().toISOString().slice(0,10)}.xlsx`,f=URL.createObjectURL(s);D(d,f,!0)};const u=c.querySelector("#copy-clipboard-btn");u.onclick=()=>{if(!l)return;const s=I(l);B(s).then(()=>{u.classList.add("copied"),setTimeout(()=>{u.classList.remove("copied")},2e3)})},t.items.forEach(s=>{const d=document.createElement("div");d.className="slide-item";const f=H(s.content);d.innerHTML=`
      <div class="slide-item-header">
        <h3 class="slide-item__title">${s.title}</h3>
        <div class="slide-item-time">
          ${s.startTime} - ${s.endTime}
        </div>
      </div>
      <div class="duration-slider-container">
        <input type="range" min="0" max="60" value="${s.duration}" class="duration-slider" data-slide-id="${s.id}">
        <span class="duration-display">${parseInt(s.duration,10)} min</span>
      </div>
      <div class="slide-item-content">${f}</div>
    `,e.appendChild(d)}),e.querySelectorAll(".duration-slider").forEach(s=>{s.addEventListener("input",N),s.addEventListener("change",U)})}const S=w(async()=>{if(l){const t=`timetable-${T}`;$(t,l),console.log("Timetable saved.")}},500);function N(t){const e=parseInt(t.target.value,10),n=t.target.nextElementSibling;n&&(n.textContent=`${e} min`)}function U(t){const e=t.target.getAttribute("data-slide-id"),n=parseInt(t.target.value,10),o=l.items.find(a=>a.id===e);if(o){o.duration=n;const a=v(l);y(a),S()}const i=t.target.nextElementSibling;i&&(i.textContent=`${n} min`)}function v(t){let e=new Date(`1970-01-01T${t.startTime}:00`),n=0;const o=t.items.map(i=>{const a=new Date(e),c=i.duration;e.setMinutes(e.getMinutes()+c);const r=new Date(e);return n+=c,{...i,startTime:a.toTimeString().slice(0,5),endTime:r.toTimeString().slice(0,5)}});return{...t,items:o,totalDuration:n}}document.addEventListener("DOMContentLoaded",async()=>{console.log("[SIDEBAR] DOMContentLoaded fired");const t=document.getElementById("version-display");t&&(t.textContent=`v${R}`),X()});
