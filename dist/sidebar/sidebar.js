import{l as $,d as k,s as R,a as B,c as T}from"../assets/index.js";function L(e,t={}){const{startTime:n="09:00",defaultDuration:o=5,breakAfter:i=60,breakDuration:a=10,existingItems:r=[]}=t;let s=new Date(`1970-01-01T${n}:00`),u=0;const c=e.map(g=>{const p=r.find(A=>A.id===g.id),l=p?p.duration:o,m=new Date(s);s.setMinutes(s.getMinutes()+l);const b=new Date(s);return u+=l,{id:g.id,title:g.title,content:g.content,startTime:m.toTimeString().slice(0,5),endTime:b.toTimeString().slice(0,5),duration:l}});return{startTime:n,items:c,totalDuration:u}}function D(e){let t=`Item,Start Time,Duration (min),End Time
`;return e.items.forEach(n=>{const o=n.title.replace(/"/g,'""');t+=`"${o}",${n.startTime},${n.duration},${n.endTime}
`}),t}function C(e,t,n=!1){const o=document.createElement("a");if(o.setAttribute("download",e),o.style.visibility="hidden",document.body.appendChild(o),n)o.href=t;else{const i=new Blob([t],{type:"text/csv;charset=utf-8;"});o.href=URL.createObjectURL(i)}o.click(),document.body.removeChild(o)}function M(e){var u;const t=((u=e.items[0])==null?void 0:u.title)||"Course Timetable",n=e.items.map(c=>[c.startTime,c.endTime,c.duration,c.title]),i=[[t],["Start","End","Duration","Slide title"],...n],a=XLSX.utils.aoa_to_sheet(i);a["!cols"]=[{wch:10},{wch:10},{wch:10},{wch:80}];const r=XLSX.utils.book_new();XLSX.utils.book_append_sheet(r,a,"Timetable");const s=XLSX.write(r,{bookType:"xlsx",type:"array"});return new Blob([s],{type:"application/octet-stream"})}function U(e){return navigator.clipboard.writeText(e)}function H(e,t){return R(e,t)}function N(e){return $(e)}function w(e,t){return k(e,t)}console.log("[SIDEBAR] Script loaded");const X="0.0.8";let E=!1,d=null,f=null,x=null,y=null;function O(e){if(!d){console.log("[SIDEBAR] No current timetable, generating a new one.");const i=L(e);I(i),S();return}console.log("[SIDEBAR] Reconciling new slide data with existing timetable.");const t=[],n=new Map(d.items.map(i=>[i.id,i]));new Map(e.map(i=>[i.id,i]));for(const i of e){const a=n.get(i.id);a?t.push({...a,title:i.title,content:i.content}):t.push({...i,duration:5})}d.items=t;const o=v(d);I(o),S()}const _=async(e,t)=>{var i;console.log(`[SIDEBAR] updateUIWithNewSlides called for tab ${t} with`,(e==null?void 0:e.length)||0,"slides");const n=document.getElementById("sidebar-footer");if(e.length===0){document.getElementById("sidebar-main").innerHTML="<p>No slides detected in this Gamma presentation.</p>",n&&(n.innerHTML=h(e,"Received: slide-data (empty)"));return}const o=(i=e[0])==null?void 0:i.presentationUrl;if(o){if(o!==x){console.log(`[SIDEBAR] Switched to new presentation: ${o}. Loading from storage...`),x=o;const a=`timetable-${o}`,r=await N(a);r?(console.log("[SIDEBAR] Found stored timetable."),d=r):(console.log("[SIDEBAR] No stored timetable, generating a new one..."),d=L(e))}O(e),n&&(n.innerHTML=h(e,"Rendered: slide-data"))}};function q(){if(console.log("[SIDEBAR] Connecting to background script..."),f=chrome.runtime.connect({name:"sidebar"}),console.log("[SIDEBAR] Connected to background"),!f){console.error("[SIDEBAR] Failed to create port connection");return}E=!0;const e=document.getElementById("sidebar-footer");e&&(e.innerHTML=h([],"Connected to background")),f.onMessage.addListener(t=>{var n;if(console.log("[SIDEBAR] Received message from background:",t),t.type==="slide-data")console.log("[SIDEBAR] Received slide-data for tab",t.tabId,"with",((n=t.slides)==null?void 0:n.length)||0,"slides"),_(t.slides,t.tabId);else if(t.type==="gamma-tab-activated")console.log(`[SIDEBAR] Gamma tab ${t.tabId} activated. Requesting new slides.`),t.tabId,document.getElementById("sidebar-main").innerHTML="<p>Loading timetable...</p>",f.postMessage({type:"get-slides"});else if(t.type==="show-message"){console.log(`[SIDEBAR] Displaying message: ${t.message}`),document.getElementById("sidebar-main").innerHTML=`<p>${t.message}</p>`;const o=document.getElementById("timetable-title");o&&(o.textContent="Gamma Timetable");const i=document.getElementById("duration-badge");i&&(i.textContent="0h 0m")}else if(t.type==="error"){console.error("[SIDEBAR] Error from background:",t.message),document.getElementById("sidebar-main").innerHTML=`<p style="color: red;">${t.message}</p>`;const o=document.getElementById("sidebar-footer");o&&(o.innerHTML=h([],"Error: "+t.message))}}),f.onDisconnect.addListener(()=>{f=null,E=!1,console.log("[SIDEBAR] Disconnected from background script.");const t=document.getElementById("sidebar-footer");t&&(t.innerHTML=h([],"Disconnected"))})}function F(e){let t="";return e.forEach(n=>{switch(n.type){case"paragraph":t+=`<p>${n.text}</p>`;break;case"image":t+=`<img src="${n.text}" class="thumbnail-img">`;break;case"link":t+=`<a href="${n.text}" target="_blank" class="content-link">${n.text}</a>`;break;case"list_item":t+=`<p>${n.text}</p>`,n.subItems&&n.subItems.length>0&&(t+='<ul class="sub-items-list">',n.subItems.forEach(o=>{t+=`<li class="sub-item">${o}</li>`}),t+="</ul>");break}}),t}function G(e,t){const n=document.createElement("div");n.className="time-input-container";const[o,i]=e.startTime.split(":"),a=document.createElement("input");a.type="text",a.className="time-input-segment",a.value=o,a.maxLength=2,a.placeholder="00";const r=document.createElement("span");r.className="time-input-separator",r.textContent=":";const s=document.createElement("input");s.type="text",s.className="time-input-segment",s.value=i,s.maxLength=2,s.placeholder="00";const c=w(()=>{const g=a.value.padStart(2,"0"),p=s.value.padStart(2,"0"),l=parseInt(g,10),m=parseInt(p,10);l>=0&&l<=23&&m>=0&&m<=59&&t(`${g}:${p}`)},400);return a.addEventListener("input",()=>{a.value.length>=2&&(a.value=a.value.slice(0,2),s.focus()),c()}),s.addEventListener("input",()=>{s.value.length>=2&&(s.value=s.value.slice(0,2)),c()}),n.appendChild(a),n.appendChild(r),n.appendChild(s),n}function h(e=[],t="none"){const n=e.length;let o=e[0]?JSON.stringify(e[0],null,2):"N/A";return`
    <div class="debug-info">
      <strong>Debug Info (v${X})</strong><br>
      Slides Detected: <strong>${n}</strong><br>
      Connection Status: <span style="color:${E?"green":"red"};font-weight:bold;">${E?"Connected":"Disconnected"}</span><br>
      Last Action: <span style="font-family: monospace;">${t}</span><br>
      <details><summary>First Slide Preview</summary><pre>${o}</pre></details>
    </div>
  `}function I(e){var p;d=e;const t=document.getElementById("sidebar-main");if(!t)return;const n=document.getElementById("timetable-title");n&&(n.textContent=((p=e.items[0])==null?void 0:p.title)||"Course Timetable");const o=document.getElementById("duration-badge");if(o){const l=Math.floor(e.totalDuration/60),m=e.totalDuration%60;o.textContent=`${l}h ${m}m`}const i=document.getElementById("functions-toolbar");if(!i)return;i.innerHTML="";const a=document.createElement("div");a.className="time-display-section",a.prepend(G(e,l=>{d.startTime=l;const m=v(d);I(m),S()})),i.appendChild(a);const r=document.createElement("div");r.className="export-options",r.innerHTML=`
    <button id="export-csv-btn" class="export-btn"><img src="/assets/csv.svg" alt="CSV">CSV</button>
    <button id="export-xlsx-btn" class="export-btn"><img src="/assets/xlsx.svg" alt="Excel">Excel</button>
    <button id="copy-clipboard-btn" class="export-btn copy-btn-icon-only"><img src="/assets/copy.svg" alt="Copy"></button>
  `,i.appendChild(r),t.innerHTML="";const s=r.querySelector("#export-csv-btn");s.onclick=()=>{if(!d)return;const l=D(d),m=`gamma-timetable-${new Date().toISOString().slice(0,10)}.csv`;C(m,l)};const u=r.querySelector("#export-xlsx-btn");u.onclick=()=>{if(!d)return;const l=M(d),m=`gamma-timetable-${new Date().toISOString().slice(0,10)}.xlsx`,b=URL.createObjectURL(l);C(m,b,!0)};const c=r.querySelector("#copy-clipboard-btn");c.onclick=()=>{if(!d)return;const l=D(d);U(l).then(()=>{c.classList.add("copied"),setTimeout(()=>{c.classList.remove("copied")},2e3)})},e.items.forEach(l=>{const m=document.createElement("div");m.className="slide-item";const b=F(l.content);m.innerHTML=`
      <div class="slide-item-header">
        <h3 class="slide-item__title">${l.title}</h3>
        <div class="slide-item-time">
          ${l.startTime} - ${l.endTime}
        </div>
      </div>
      <div class="duration-slider-container">
        <input type="range" min="0" max="60" value="${l.duration}" class="duration-slider" data-slide-id="${l.id}">
        <span class="duration-display">${parseInt(l.duration,10)} min</span>
      </div>
      <div class="slide-item-content">${b}</div>
    `,t.appendChild(m)}),t.querySelectorAll(".duration-slider").forEach(l=>{l.addEventListener("input",z),l.addEventListener("change",V)})}const S=w(async()=>{if(d){const e=`timetable-${x}`;H(e,d),console.log("Timetable saved.")}},500);function z(e){const t=parseInt(e.target.value,10),n=e.target.nextElementSibling;n&&(n.textContent=`${t} min`)}function V(e){const t=e.target.getAttribute("data-slide-id"),n=parseInt(e.target.value,10),o=d.items.find(a=>a.id===t);if(o){o.duration=n;const a=v(d);I(a),S()}const i=e.target.nextElementSibling;i&&(i.textContent=`${n} min`)}function v(e){let t=new Date(`1970-01-01T${e.startTime}:00`),n=0;const o=e.items.map(i=>{const a=new Date(t),r=i.duration;t.setMinutes(t.getMinutes()+r);const s=new Date(t);return n+=r,{...i,startTime:a.toTimeString().slice(0,5),endTime:s.toTimeString().slice(0,5)}});return{...e,items:o,totalDuration:n}}async function j(){const e=B.shouldShowAuthUI(),t=document.getElementById("auth-header");document.getElementById("auth-user-name"),document.getElementById("auth-user-email"),document.getElementById("auth-avatar"),document.getElementById("auth-status-badge"),document.getElementById("auth-sync-status"),document.getElementById("sync-status-text");const n=document.getElementById("auth-login-btn"),o=document.getElementById("auth-logout-btn"),i=document.getElementById("auth-sync-btn");if(!t){console.log("[SIDEBAR] Auth UI elements not found");return}e?(t.style.display="block",console.log("[SIDEBAR] Authentication UI enabled")):(t.style.display="none",console.log("[SIDEBAR] Authentication UI hidden (Sprint 0)")),y=B.onAuthStateChange(a=>{P(a)}),n&&n.addEventListener("click",W),o&&o.addEventListener("click",J),i&&i.addEventListener("click",K),console.log("[SIDEBAR] Authentication system initialized")}function P(e){const t=document.getElementById("auth-user-name"),n=document.getElementById("auth-user-email"),o=document.getElementById("auth-avatar"),i=document.getElementById("auth-status-badge"),a=document.getElementById("auth-sync-status"),r=document.getElementById("sync-status-text"),s=document.getElementById("auth-login-btn"),u=document.getElementById("auth-logout-btn"),c=document.getElementById("auth-sync-btn");!t||!n||!o||!i||(e.isLoading?(t.textContent="Loading...",n.textContent="Checking authentication...",o.textContent="...",i.textContent="Loading",i.className="auth-status-badge guest",s&&(s.disabled=!0),u&&(u.disabled=!0),c&&(c.disabled=!0)):e.isAuthenticated&&e.user?(t.textContent=e.user.name||e.user.email,n.textContent=e.user.email,o.textContent=e.user.name?e.user.name.charAt(0).toUpperCase():"U",i.textContent="Signed In",i.className="auth-status-badge authenticated",s&&(s.style.display="none",s.disabled=!1),u&&(u.style.display="inline-block",u.disabled=!1),c&&T.isFeatureEnabled("cloudSync")&&(c.style.display="inline-block",c.disabled=!1),a&&T.isFeatureEnabled("cloudSync")&&(a.style.display="block",r&&(r.textContent="Cloud sync enabled"))):(t.textContent="Guest User",n.textContent="Not signed in",o.textContent="G",i.textContent="Guest",i.className="auth-status-badge guest",s&&(s.style.display="inline-block",s.disabled=!1),u&&(u.style.display="none",u.disabled=!1),c&&(c.style.display="none"),a&&(a.style.display="block",r&&(r.textContent="Offline mode - Local storage only"))),e.lastError&&console.error("[SIDEBAR] Auth error:",e.lastError))}async function W(){try{console.log("[SIDEBAR] Login attempted - will be implemented in Sprint 1");const e=document.getElementById("sidebar-footer");e&&(e.innerHTML=`
        <div class="auth-info-message" style="background-color: #e3f2fd; border: 1px solid #90caf9; border-radius: 4px; padding: 12px; color: #1565c0; font-size: 14px;">
          <strong>Coming Soon!</strong><br>
          User authentication and cloud sync will be available in the next update.
          <br><small>Currently running in guest mode with local storage.</small>
        </div>
      `)}catch(e){console.error("[SIDEBAR] Login failed:",e)}}async function J(){try{await B.logout(),console.log("[SIDEBAR] User logged out");const e=document.getElementById("sidebar-footer");e&&(e.innerHTML=`
        <div class="auth-info-message" style="background-color: #f3e5f5; border: 1px solid #ce93d8; border-radius: 4px; padding: 12px; color: #7b1fa2; font-size: 14px;">
          Switched to guest mode - data saved locally.
        </div>
      `)}catch(e){console.error("[SIDEBAR] Logout failed:",e)}}async function K(){try{console.log("[SIDEBAR] Manual sync requested - will be implemented in Sprint 2");const e=document.getElementById("sidebar-footer");e&&(e.innerHTML=`
        <div class="auth-info-message" style="background-color: #fff3e0; border: 1px solid #ffcc02; border-radius: 4px; padding: 12px; color: #f57c00; font-size: 14px;">
          Cloud sync will be available in Sprint 2 with backend integration.
        </div>
      `)}catch(e){console.error("[SIDEBAR] Sync failed:",e)}}function Q(){y&&(y(),y=null,console.log("[SIDEBAR] Authentication listeners cleaned up"))}document.addEventListener("DOMContentLoaded",async()=>{console.log("[SIDEBAR] DOMContentLoaded fired"),await j(),q()});window.addEventListener("beforeunload",()=>{Q()});
