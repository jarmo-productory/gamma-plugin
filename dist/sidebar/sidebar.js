import{l as R,d as M,s as U,c as E,a as b,b as T}from"../assets/index.js";function L(e,n={}){const{startTime:t="09:00",defaultDuration:a=5,existingItems:i=[]}=n,o=new Date(`1970-01-01T${t}:00`);let r=0;const l=e.map(d=>{const c=i.find(p=>p.id===d.id),s=c?c.duration:a,u=new Date(o);o.setMinutes(o.getMinutes()+s);const g=new Date(o);return r+=s,{id:d.id,title:d.title,content:d.content,startTime:u.toTimeString().slice(0,5),endTime:g.toTimeString().slice(0,5),duration:s}});return{startTime:t,items:l,totalDuration:r}}function N(e,n,t=!1){const a=document.createElement("a");if(a.setAttribute("download",e),a.style.visibility="hidden",document.body.appendChild(a),t)a.href=n;else{const i=new Blob([n],{type:"text/csv;charset=utf-8;"});a.href=URL.createObjectURL(i)}a.click(),document.body.removeChild(a)}function H(e){var d;const n=((d=e.items[0])==null?void 0:d.title)||"Course Timetable",t=e.items.map(c=>[c.startTime,c.endTime,c.duration,c.title]),i=[[n],["Start","End","Duration","Slide title"],...t],o=XLSX.utils.aoa_to_sheet(i);o["!cols"]=[{wch:10},{wch:10},{wch:10},{wch:80}];const r=XLSX.utils.book_new();XLSX.utils.book_append_sheet(r,o,"Timetable");const l=XLSX.write(r,{bookType:"xlsx",type:"array"});return new Blob([l],{type:"application/octet-stream"})}function F(e,n){return U(e,n)}function X(e){return R(e)}function k(e,n){return M(e,n)}console.log("[SIDEBAR] Script loaded");const _="0.0.22";let y=!1,D=[],m=null,f=null,v=null,z=!1,O=!1;function q(e){if(!m){console.log("[SIDEBAR] No current timetable, generating a new one.");const i=L(e);I(i),S();return}console.log("[SIDEBAR] Reconciling new slide data with existing timetable.");const n=[],t=new Map(m.items.map(i=>[i.id,i]));for(const i of e){const o=t.get(i.id);o?n.push({...o,title:i.title,content:i.content}):n.push({...i,duration:5})}m.items=n;const a=B(m);I(a),S()}const W=async(e,n)=>{var a;if(console.log(`[SIDEBAR] updateUIWithNewSlides called for tab ${n} with`,(e==null?void 0:e.length)||0,"slides"),D=e||[],e.length===0){document.getElementById("sidebar-main").innerHTML="<p>No slides detected in this Gamma presentation.</p>",h(e,"Received: slide-data (empty)");return}const t=(a=e[0])==null?void 0:a.presentationUrl;if(t){if(t!==v){console.log(`[SIDEBAR] Switched to new presentation: ${t}. Loading from storage...`),v=t;const i=`timetable-${t}`,o=await X(i);o?(console.log("[SIDEBAR] Found stored timetable."),m=o):(console.log("[SIDEBAR] No stored timetable, generating a new one..."),m=L(e))}q(e),h(e,"Rendered: slide-data")}};function j(){if(console.log("[SIDEBAR] Connecting to background script..."),f=chrome.runtime.connect({name:"sidebar"}),console.log("[SIDEBAR] Connected to background"),!f){console.error("[SIDEBAR] Failed to create port connection");return}y=!0,h(D,"Connected to background"),f.onMessage.addListener(e=>{if(console.log("[SIDEBAR] Received message from background:",e),e.type==="slide-data")W(e.slides,e.tabId);else if(e.type==="gamma-tab-activated")e.tabId,document.getElementById("sidebar-main").innerHTML="<p>Loading timetable...</p>",f.postMessage({type:"get-slides"});else if(e.type==="show-message"){document.getElementById("sidebar-main").innerHTML=`<p>${e.message}</p>`;const n=document.getElementById("timetable-title");n&&(n.textContent="Gamma Timetable");const t=document.getElementById("duration-badge");t&&(t.textContent="0h 0m")}else e.type==="error"&&(console.error("[SIDEBAR] Error from background:",e.message),document.getElementById("sidebar-main").innerHTML=`<p style="color: red;">${e.message}</p>`)}),f.onDisconnect.addListener(()=>{f=null,y=!1,console.log("[SIDEBAR] Disconnected from background script."),h(D,"Disconnected")})}function G(e){let n="";return e.forEach(t=>{switch(t.type){case"paragraph":n+=`<p>${t.text}</p>`;break;case"image":n+=`<img src="${t.text}" class="thumbnail-img">`;break;case"link":n+=`<a href="${t.text}" target="_blank" class="content-link">${t.text}</a>`;break;case"list_item":n+=`<p>${t.text}</p>`,t.subItems&&t.subItems.length>0&&(n+='<ul class="sub-items-list">',t.subItems.forEach(a=>{n+=`<li class="sub-item">${a}</li>`}),n+="</ul>");break}}),n}function P(e,n){const t=document.createElement("div");t.className="time-input-container";const[a,i]=e.startTime.split(":"),o=document.createElement("input");o.type="text",o.className="time-input-segment",o.value=a,o.maxLength=2,o.placeholder="00";const r=document.createElement("span");r.className="time-input-separator",r.textContent=":";const l=document.createElement("input");l.type="text",l.className="time-input-segment",l.value=i,l.maxLength=2,l.placeholder="00";const c=k(()=>{const s=o.value.padStart(2,"0"),u=l.value.padStart(2,"0"),g=parseInt(s,10),p=parseInt(u,10);g>=0&&g<=23&&p>=0&&p<=59&&n(`${s}:${u}`)},400);return o.addEventListener("input",()=>{o.value.length>=2&&(o.value=o.value.slice(0,2),l.focus()),c()}),l.addEventListener("input",()=>{l.value.length>=2&&(l.value=l.value.slice(0,2)),c()}),t.appendChild(o),t.appendChild(r),t.appendChild(l),t}function J(e=[],n="none",t={}){const{authFeatureEnabled:a=!1,isAuthenticated:i=!1,userEmail:o=""}=t,{debugMode:r=!1}=t,l=e.length,d=e[0]?JSON.stringify(e[0],null,2):"N/A",c=a,s=c&&r?i?`<div style="margin-top:6px;"><span>Logged in as <strong>${o||"user"}</strong></span> <button id="debug-logout-btn" class="export-btn" style="margin-left:8px;">Logout</button></div>`:'<div style="margin-top:6px;"><button id="debug-login-btn" class="export-btn">Login</button></div>':"";return`
        <strong>Debug Info (v${_})</strong><br>
        Auth Feature: <strong style="color: ${c?"green":"red"}">${c?"ENABLED":"DISABLED"}</strong><br>
        Slides Detected: <strong>${l}</strong><br>
        Connection Status: <span style="color:${y?"green":"red"};font-weight:bold;">${y?"Connected":"Disconnected"}</span><br>
        Last Action: <span style="font-family: monospace;">${n}</span><br>
        ${s}
        <details><summary>First Slide Preview</summary><pre>${d}</pre></details>
    `}async function h(e=[],n="none"){const t=document.getElementById("debug-info");if(!t)return;const a=E.isFeatureEnabled("authentication"),i=E.isFeatureEnabled("debugMode");let o=!1,r="";if(a)try{o=await b.isAuthenticated();const c=await b.getCurrentUser();r=(c==null?void 0:c.email)||""}catch{}t.innerHTML=J(e,n,{authFeatureEnabled:a,isAuthenticated:o,userEmail:r,debugMode:i});const l=document.getElementById("debug-login-btn");l&&l.addEventListener("click",async()=>{console.log("[SIDEBAR] Debug login button clicked"),await b.login()});const d=document.getElementById("debug-logout-btn");d&&d.addEventListener("click",async()=>{console.log("[SIDEBAR] Debug logout button clicked"),await b.logout()})}function I(e){var c;m=e;const n=document.getElementById("sidebar-main");if(!n)return;const t=document.getElementById("timetable-title");t&&(t.textContent=((c=e.items[0])==null?void 0:c.title)||"Course Timetable");const a=document.getElementById("duration-badge");if(a){const s=Math.floor(e.totalDuration/60),u=e.totalDuration%60;a.textContent=`${s}h ${u}m`}const i=document.getElementById("functions-toolbar");if(!i)return;i.innerHTML="";const o=document.createElement("div");o.className="time-display-section",o.prepend(P(e,s=>{m.startTime=s;const u=B(m);I(u),S()})),i.appendChild(o);const r=document.createElement("div");r.className="export-options",r.innerHTML=`
    <button id="export-xlsx-btn" class="export-btn"><img src="/assets/xlsx.svg" alt="Excel">Excel</button>
    <button id="auth-login-toolbar-btn" class="export-btn"><span>üîê</span><span id="auth-toolbar-text">Login</span></button>
  `,i.appendChild(r),n.innerHTML="",r.querySelector("#export-xlsx-btn").onclick=()=>{if(!m)return;const s=H(m),u=`gamma-timetable-${new Date().toISOString().slice(0,10)}.xlsx`,g=URL.createObjectURL(s);N(u,g,!0)};const l=r.querySelector("#auth-login-toolbar-btn"),d=r.querySelector("#auth-toolbar-text");if(l&&d){const s=async()=>{await b.isAuthenticated()?(d.textContent="Logout",l.onclick=async()=>{console.log("[SIDEBAR] Toolbar logout button clicked"),await b.logout(),await s()}):(d.textContent="Login",l.onclick=async()=>{var g;console.log("[SIDEBAR] Toolbar login button clicked (web-first pairing)");try{const p=E.getConfig(),x=p.environment.apiBaseUrl||"http://localhost:3000",$=p.environment.webBaseUrl||"http://localhost:3000",w=await T.getOrRegisterDevice(x),A=T.buildSignInUrl($,w.code);(g=chrome==null?void 0:chrome.tabs)!=null&&g.create?chrome.tabs.create({url:A}):window!=null&&window.open&&window.open(A,"_blank"),await T.pollExchangeUntilLinked(x,w.deviceId,w.code)?(console.log("[SIDEBAR] Device linked; token stored."),await s()):console.warn("[SIDEBAR] Device linking timed out.")}catch(p){console.error("[SIDEBAR] Web-first login failed:",p)}})};s()}e.items.forEach(s=>{const u=document.createElement("div");u.className="slide-item";const g=G(s.content);u.innerHTML=`
      <div class="slide-item-header">
        <h3 class="slide-item__title">${s.title}</h3>
        <div class="slide-item-time">
          ${s.startTime} - ${s.endTime}
        </div>
      </div>
      <div class="duration-slider-container">
        <input type="range" min="0" max="60" value="${s.duration}" class="duration-slider" data-slide-id="${s.id}">
        <span class="duration-display">${parseInt(s.duration,10)} min</span>
      </div>
      <div class="slide-item-content">${g}</div>
    `,n.appendChild(u)}),n.querySelectorAll(".duration-slider").forEach(s=>{s.addEventListener("input",K),s.addEventListener("change",V)})}const S=k(async()=>{if(m){const e=`timetable-${v}`;F(e,m),console.log("Timetable saved.")}},500);function K(e){const n=parseInt(e.target.value,10),t=e.target.nextElementSibling;t&&(t.textContent=`${n} min`)}function V(e){const n=e.target.getAttribute("data-slide-id"),t=parseInt(e.target.value,10),a=m.items.find(o=>o.id===n);if(a){a.duration=t;const o=B(m);I(o),S()}const i=e.target.nextElementSibling;i&&(i.textContent=`${t} min`)}function B(e){const n=new Date(`1970-01-01T${e.startTime}:00`);let t=0;const a=e.items.map(i=>{const o=new Date(n),r=i.duration;n.setMinutes(n.getMinutes()+r);const l=new Date(n);return t+=r,{...i,startTime:o.toTimeString().slice(0,5),endTime:l.toTimeString().slice(0,5)}});return{...e,items:a,totalDuration:t}}document.addEventListener("DOMContentLoaded",async()=>{console.log("[SIDEBAR] DOMContentLoaded fired"),await Q(),j()});async function Q(){try{console.log("[SIDEBAR] Initializing infrastructure..."),await E.initialize(),O=!0,console.log("[SIDEBAR] ConfigManager initialized"),await b.initialize(),z=!0,console.log("[SIDEBAR] AuthManager initialized"),console.log("[SIDEBAR] Clerk key present at build:",!0),await Y(),Z(),h([],"Infrastructure ready"),console.log("[SIDEBAR] Infrastructure ready")}catch(e){console.error("[SIDEBAR] Failed to initialize infrastructure:",e),console.log("[SIDEBAR] Continuing in fallback mode...")}}async function Y(){await C()}async function C(){const e=document.getElementById("auth-status-bar");if(!e)return;if(!(await E.getConfig()).features.authentication){e.style.display="none";return}e.style.display="none"}function Z(){b.addEventListener(async e=>{console.log("[SIDEBAR] Auth state changed:",e.type),await C(),h(D,`Auth event: ${e.type}`)})}
