import{l as z,s as P,d as W,c as D,a as w,b as F,e as A,f as V}from"../assets/index.js";function H(e,t={}){const{startTime:n="09:00",defaultDuration:a=5,existingItems:s=[]}=t,o=new Date(`1970-01-01T${n}:00`);let c=0;const i=e.map(r=>{const d=s.find(E=>E.id===r.id),b=d?d.duration:a,m=new Date(o);o.setMinutes(o.getMinutes()+b);const g=new Date(o);return c+=b,{id:r.id,title:r.title,content:r.content,startTime:m.toTimeString().slice(0,5),endTime:g.toTimeString().slice(0,5),duration:b}});return{startTime:n,items:i,totalDuration:c}}function K(e,t,n=!1){const a=document.createElement("a");if(a.setAttribute("download",e),a.style.visibility="hidden",document.body.appendChild(a),n)a.href=t;else{const s=new Blob([t],{type:"text/csv;charset=utf-8;"});a.href=URL.createObjectURL(s)}a.click(),document.body.removeChild(a)}function j(e){var r;const t=((r=e.items[0])==null?void 0:r.title)||"Course Timetable",n=e.items.map(d=>[d.startTime,d.endTime,d.duration,d.title]),s=[[t],["Start","End","Duration","Slide title"],...n],o=XLSX.utils.aoa_to_sheet(s);o["!cols"]=[{wch:10},{wch:10},{wch:10},{wch:80}];const c=XLSX.utils.book_new();XLSX.utils.book_append_sheet(c,o,"Timetable");const i=XLSX.write(c,{bookType:"xlsx",type:"array"});return new Blob([i],{type:"application/octet-stream"})}function k(e,t){return P(e,t)}function J(e){return z(e)}function _(e,t){return W(e,t)}console.log("[SIDEBAR] Script loaded");const Q="0.0.28";let R=!1,x=[],u=null,v=null,B=null,Y=!1,Z=!1;function ee(e){if(!u){console.log("[SIDEBAR] No current timetable, generating a new one.");const s=H(e);L(s),M();return}console.log("[SIDEBAR] Reconciling new slide data with existing timetable.");const t=[],n=new Map(u.items.map(s=>[s.id,s]));for(const s of e){const o=n.get(s.id);o?t.push({...o,title:s.title,content:s.content}):t.push({...s,duration:5})}u.items=t;const a=G(u);L(a),M()}const te=async(e,t)=>{var a;if(console.log(`[SIDEBAR] updateUIWithNewSlides called for tab ${t} with`,(e==null?void 0:e.length)||0,"slides"),x=e||[],e.length===0){document.getElementById("sidebar-main").innerHTML="<p>No slides detected in this Gamma presentation.</p>",C(e,"Received: slide-data (empty)");return}const n=(a=e[0])==null?void 0:a.presentationUrl;if(n){if(n!==B){console.log(`[SIDEBAR] Switched to new presentation: ${n}. Loading from storage...`),B=n;const s=`timetable-${n}`;let o=await J(s);const c=D.getConfig();if(c.features.cloudSync&&c.environment.apiBaseUrl)try{const i=await F.syncFromCloud(n,{apiBaseUrl:c.environment.apiBaseUrl,deviceAuth:A});if(i.success&&i.data){console.log("[SIDEBAR] Found cloud version, merging with local...");const r=i.data;!o||r.lastModified&&o.lastModified&&new Date(r.lastModified)>new Date(o.lastModified)?(o=r,await k(s,r),console.log("[SIDEBAR] Using cloud version (newer than local).")):console.log("[SIDEBAR] Using local version (newer than cloud).")}else!i.success&&i.error!=="Presentation not found in cloud"&&console.warn("[SIDEBAR] Cloud sync failed:",i.error)}catch(i){console.warn("[SIDEBAR] Cloud sync error (non-critical):",i)}o?(console.log("[SIDEBAR] Found stored timetable."),u=o):(console.log("[SIDEBAR] No stored timetable, generating a new one..."),u=H(e))}ee(e),C(e,"Rendered: slide-data")}};function ne(){if(console.log("[SIDEBAR] Connecting to background script..."),v=chrome.runtime.connect({name:"sidebar"}),console.log("[SIDEBAR] Connected to background"),!v){console.error("[SIDEBAR] Failed to create port connection");return}R=!0,C(x,"Connected to background"),v.onMessage.addListener(e=>{if(console.log("[SIDEBAR] Received message from background:",e),e.type==="slide-data")te(e.slides,e.tabId);else if(e.type==="gamma-tab-activated")e.tabId,document.getElementById("sidebar-main").innerHTML="<p>Loading timetable...</p>",v.postMessage({type:"get-slides"});else if(e.type==="show-message"){document.getElementById("sidebar-main").innerHTML=`<p>${e.message}</p>`;const t=document.getElementById("timetable-title");t&&(t.textContent="Gamma Timetable");const n=document.getElementById("duration-badge");n&&(n.textContent="0h 0m")}else e.type==="error"&&(console.error("[SIDEBAR] Error from background:",e.message),document.getElementById("sidebar-main").innerHTML=`<p style="color: red;">${e.message}</p>`)}),v.onDisconnect.addListener(()=>{v=null,R=!1,console.log("[SIDEBAR] Disconnected from background script."),C(x,"Disconnected")})}function oe(e){let t="";return e.forEach(n=>{switch(n.type){case"paragraph":t+=`<p>${n.text}</p>`;break;case"image":t+=`<img src="${n.text}" class="thumbnail-img">`;break;case"link":t+=`<a href="${n.text}" target="_blank" class="content-link">${n.text}</a>`;break;case"list_item":t+=`<p>${n.text}</p>`,n.subItems&&n.subItems.length>0&&(t+='<ul class="sub-items-list">',n.subItems.forEach(a=>{t+=`<li class="sub-item">${a}</li>`}),t+="</ul>");break}}),t}function ae(e,t){const n=document.createElement("div");n.className="time-input-container";const[a,s]=e.startTime.split(":"),o=document.createElement("input");o.type="text",o.className="time-input-segment",o.value=a,o.maxLength=2,o.placeholder="00",o.inputMode="numeric";const c=document.createElement("span");c.className="time-input-separator",c.textContent=":";const i=document.createElement("input");i.type="text",i.className="time-input-segment",i.value=s,i.maxLength=2,i.placeholder="00",i.inputMode="numeric";let r=!1;const d=()=>{const l=o.value.trim(),p=i.value.trim();if(l&&p){const f=parseInt(l,10),y=parseInt(p,10);if(!isNaN(f)&&!isNaN(y)&&f>=0&&f<=23&&y>=0&&y<=59){const U=`${l.padStart(2,"0")}:${p.padStart(2,"0")}`;t(U)}}},b=_(d,200),m=(l,p)=>{const f=p.target.value,y=f.replace(/[^0-9]/g,"");return y!==f&&(p.target.value=y),y},g=(l,p)=>{if(l.length===2){const f=parseInt(l,10);return!isNaN(f)&&f>=0&&f<=23}return!1},E=()=>{r=!0},I=()=>{r=!1,d()};o.addEventListener("focus",E),o.addEventListener("blur",I),i.addEventListener("focus",E),i.addEventListener("blur",I),o.addEventListener("input",l=>{const p=m(o,l);g(p)&&setTimeout(()=>i.focus(),50),b()}),o.addEventListener("keydown",l=>{if(l.key==="ArrowUp"||l.key==="ArrowDown"){l.preventDefault();const p=parseInt(o.value||"0",10),f=l.key==="ArrowUp"?1:-1,y=Math.max(0,Math.min(23,p+f));o.value=y.toString().padStart(2,"0"),b()}l.key==="Enter"&&(i.focus(),d())}),i.addEventListener("input",l=>{m(i,l),b()}),i.addEventListener("keydown",l=>{if(l.key==="ArrowUp"||l.key==="ArrowDown"){l.preventDefault();const p=parseInt(i.value||"0",10),f=l.key==="ArrowUp"?1:-1,y=Math.max(0,Math.min(59,p+f));i.value=y.toString().padStart(2,"0"),b()}l.key==="Enter"&&(d(),o.focus()),l.key==="Backspace"&&i.value===""&&o.focus()});const T=l=>{l.preventDefault();const f=l.clipboardData.getData("text").trim().match(/^(\d{1,2}):?(\d{2})$/);if(f){const[,y,U]=f,$=parseInt(y,10),N=parseInt(U,10);$>=0&&$<=23&&N>=0&&N<=59&&(o.value=$.toString().padStart(2,"0"),i.value=N.toString().padStart(2,"0"),d())}};return o.addEventListener("paste",T),i.addEventListener("paste",T),n.appendChild(o),n.appendChild(c),n.appendChild(i),n._hasFocus=()=>r,n}function ie(e=[],t="none",n={}){const{authFeatureEnabled:a=!1,isAuthenticated:s=!1,userEmail:o=""}=n,{debugMode:c=!1}=n,i=e.length,r=e[0]?JSON.stringify(e[0],null,2):"N/A",d=a,b=d&&c?s?`<div style="margin-top:6px;"><span>Logged in as <strong>${o||"user"}</strong></span> <button id="debug-logout-btn" class="export-btn" style="margin-left:8px;">Logout</button></div>`:'<div style="margin-top:6px;"><button id="debug-login-btn" class="export-btn">Login</button></div>':"";return`
        <strong>Debug Info (v${Q})</strong><br>
        Auth Feature: <strong style="color: ${d?"green":"red"}">${d?"ENABLED":"DISABLED"}</strong><br>
        Slides Detected: <strong>${i}</strong><br>
        Connection Status: <span style="color:${R?"green":"red"};font-weight:bold;">${R?"Connected":"Disconnected"}</span><br>
        Last Action: <span style="font-family: monospace;">${t}</span><br>
        ${b}
        <details><summary>First Slide Preview</summary><pre>${r}</pre></details>
    `}async function C(e=[],t="none"){const n=document.getElementById("debug-info");if(!n)return;const a=D.isFeatureEnabled("authentication"),s=D.isFeatureEnabled("debugMode");let o=!1,c="";if(a)try{o=await w.isAuthenticated();const d=await w.getCurrentUser();c=(d==null?void 0:d.email)||""}catch{}n.innerHTML=ie(e,t,{authFeatureEnabled:a,isAuthenticated:o,userEmail:c,debugMode:s});const i=document.getElementById("debug-login-btn");i&&i.addEventListener("click",async()=>{console.log("[SIDEBAR] Debug login button clicked"),await w.login()});const r=document.getElementById("debug-logout-btn");r&&r.addEventListener("click",async()=>{console.log("[SIDEBAR] Debug logout button clicked"),await w.logout()})}function L(e){var b;console.log("[DEBUG] renderTimetable() called - about to recreate login button"),u=e;const t=document.getElementById("sidebar-main");if(!t)return;const n=document.getElementById("timetable-title");n&&(n.textContent=((b=e.items[0])==null?void 0:b.title)||"Course Timetable");const a=document.getElementById("duration-badge");if(a){const m=Math.floor(e.totalDuration/60),g=e.totalDuration%60;a.textContent=`${m}h ${g}m`}const s=document.getElementById("functions-toolbar");if(!s)return;s.innerHTML="";const o=document.createElement("div");o.className="time-display-section";const c=ae(e,m=>{u.startTime=m;const g=G(u);(!c._hasFocus||!c._hasFocus())&&L(g),M()});o.prepend(c),s.appendChild(o);const i=document.createElement("div");i.className="export-options",i.innerHTML=`
    <button id="export-xlsx-btn" class="export-btn"><img src="/assets/xlsx.svg" alt="Excel">Excel</button>
    <button id="auth-login-toolbar-btn" class="export-btn"><span>üîê</span><span id="auth-toolbar-text">Login</span></button>
  `,s.appendChild(i),t.innerHTML="",i.querySelector("#export-xlsx-btn").onclick=()=>{if(!u)return;const m=j(u),g=`gamma-timetable-${new Date().toISOString().slice(0,10)}.xlsx`,E=URL.createObjectURL(m);K(g,E,!0)};const r=i.querySelector("#auth-login-toolbar-btn"),d=i.querySelector("#auth-toolbar-text");if(console.log("[DEBUG] Login button elements found:",{loginToolbarBtn:!!r,loginToolbarText:!!d}),r&&d){console.log("[DEBUG] Attempting to wire auth action...");const m=async()=>{console.log("[DEBUG] wireAuthAction() called");const g=await w.isAuthenticated();console.log("[DEBUG] User authentication status:",g),g?(d.textContent="Logout",r.onclick=async()=>{console.log("[SIDEBAR] Toolbar logout button clicked"),await w.logout(),await m()},console.log("[DEBUG] Logout handler attached")):(d.textContent="Login",r.onclick=async()=>{var E;console.log("[SIDEBAR] Toolbar login button clicked (web-first pairing)");try{const I=D.getConfig(),T=I.environment.apiBaseUrl||"http://localhost:3000",l=I.environment.webBaseUrl||"http://localhost:3000",p=await A.registerDevice(T),f=A.buildSignInUrl(l,p.code);(E=chrome==null?void 0:chrome.tabs)!=null&&E.create?chrome.tabs.create({url:f}):window!=null&&window.open&&window.open(f,"_blank"),await A.pollExchangeUntilLinked(T,p.deviceId,p.code)?(console.log("[SIDEBAR] Device linked; token stored."),await m()):console.warn("[SIDEBAR] Device linking timed out.")}catch(I){console.error("[SIDEBAR] Web-first login failed:",I)}},console.log("[DEBUG] Login handler attached"))};console.log("[DEBUG] About to call wireAuthAction()...");try{m().then(()=>{console.log("[DEBUG] wireAuthAction() completed successfully")}).catch(g=>{console.error("[DEBUG] wireAuthAction() failed:",g)})}catch(g){console.error("[DEBUG] wireAuthAction() failed immediately:",g)}}else console.error("[DEBUG] Login button elements NOT found - cannot wire auth action");e.items.forEach(m=>{const g=document.createElement("div");g.className="slide-item";const E=oe(m.content);g.innerHTML=`
      <div class="slide-item-header">
        <h3 class="slide-item__title">${m.title}</h3>
        <div class="slide-item-time">
          ${m.startTime} - ${m.endTime}
        </div>
      </div>
      <div class="duration-slider-container">
        <input type="range" min="0" max="60" value="${m.duration}" class="duration-slider" data-slide-id="${m.id}">
        <span class="duration-display">${parseInt(m.duration,10)} min</span>
      </div>
      <div class="slide-item-content">${E}</div>
    `,t.appendChild(g)}),t.querySelectorAll(".duration-slider").forEach(m=>{m.addEventListener("input",se),m.addEventListener("change",ce)})}const M=_(async()=>{var e;if(u&&B){const t=`timetable-${B}`;try{const n=D.getConfig(),a=n.environment.apiBaseUrl;n.features.cloudSync&&a?(await V(t,u,{deviceAuth:A,apiBaseUrl:a,title:u.title||((e=x[0])==null?void 0:e.title)||"Untitled Presentation",enableAutoSync:!0}),console.log("[SIDEBAR] Timetable saved with cloud sync.")):(await k(t,u),console.log("[SIDEBAR] Timetable saved (local only)."))}catch(n){console.error("[SIDEBAR] Save failed:",n);try{await k(t,u),console.log("[SIDEBAR] Timetable saved (fallback to local).")}catch(a){console.error("[SIDEBAR] Fallback save also failed:",a)}}}},500);function se(e){const t=parseInt(e.target.value,10),n=e.target.nextElementSibling;n&&(n.textContent=`${t} min`)}function ce(e){const t=e.target.getAttribute("data-slide-id"),n=parseInt(e.target.value,10),a=u.items.find(o=>o.id===t);if(a){a.duration=n;const o=G(u);L(o),M()}const s=e.target.nextElementSibling;s&&(s.textContent=`${n} min`)}function G(e){const t=new Date(`1970-01-01T${e.startTime}:00`);let n=0;const a=e.items.map(s=>{const o=new Date(t),c=s.duration;t.setMinutes(t.getMinutes()+c);const i=new Date(t);return n+=c,{...s,startTime:o.toTimeString().slice(0,5),endTime:i.toTimeString().slice(0,5)}});return{...e,items:a,totalDuration:n}}document.addEventListener("DOMContentLoaded",async()=>{console.log("[SIDEBAR] DOMContentLoaded fired"),await le(),ne()});async function le(){try{console.log("[SIDEBAR] Initializing infrastructure..."),await D.initialize(),Z=!0,console.log("[SIDEBAR] ConfigManager initialized"),await w.initialize(),Y=!0,console.log("[SIDEBAR] AuthManager initialized"),console.log("[SIDEBAR] Clerk key present at build:",!0),await re(),de(),C([],"Infrastructure ready"),console.log("[SIDEBAR] Infrastructure ready")}catch(e){console.error("[SIDEBAR] Failed to initialize infrastructure:",e),console.log("[SIDEBAR] Continuing in fallback mode...")}}async function re(){await O(),await q()}async function O(){const e=document.getElementById("auth-status-bar");if(!e)return;if(!(await D.getConfig()).features.authentication){e.style.display="none";return}e.style.display="none"}function de(){w.addEventListener(async e=>{console.log("[SIDEBAR] Auth state changed:",e.type),await O(),await q(),C(x,`Auth event: ${e.type}`)})}async function q(){const e=document.getElementById("cloud-sync-section");if(!e)return;const t=D.getConfig();if(!(t.features.cloudSync&&t.environment.apiBaseUrl)){e.style.display="none";return}try{if(await w.isAuthenticated()){e.style.display="block";const s=document.getElementById("save-to-cloud-btn"),o=document.getElementById("load-from-cloud-btn"),c=document.getElementById("auto-sync-toggle");s&&(s.disabled=!1),o&&(o.disabled=!1),c&&(c.disabled=!1),ue(),await pe()}else e.style.display="none"}catch(a){console.warn("[SIDEBAR] Failed to check auth state for sync controls:",a),e.style.display="none"}}function ue(){const e=document.getElementById("save-to-cloud-btn"),t=document.getElementById("load-from-cloud-btn"),n=document.getElementById("auto-sync-toggle");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",me),e.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("click",ge),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",fe),n.dataset.listenerAttached="true")}async function me(){var n,a;if(!u||!B){h("No presentation data to save","error");return}const e=document.getElementById("save-to-cloud-btn"),t=(n=e==null?void 0:e.querySelector(".sync-btn-text"))==null?void 0:n.textContent;try{if(h("Saving to cloud...","info"),S("syncing"),e){e.disabled=!0;const i=e.querySelector(".sync-btn-text");i&&(i.textContent="Saving...")}const o=D.getConfig().environment.apiBaseUrl,c=await F.syncToCloud(B,u,{apiBaseUrl:o,deviceAuth:A,title:u.title||((a=x[0])==null?void 0:a.title)||"Untitled Presentation"});if(c.success)h("Successfully saved to cloud!","success"),S("synced"),X(),console.log("[SIDEBAR] Manual save to cloud successful");else throw new Error(c.error||"Failed to save to cloud")}catch(s){console.error("[SIDEBAR] Manual save to cloud failed:",s),h(`Save failed: ${s.message}`,"error"),S("error")}finally{if(e){e.disabled=!1;const s=e.querySelector(".sync-btn-text");s&&t&&(s.textContent=t)}}}async function ge(){var n;if(!B){h("No presentation to load","error");return}const e=document.getElementById("load-from-cloud-btn"),t=(n=e==null?void 0:e.querySelector(".sync-btn-text"))==null?void 0:n.textContent;try{if(h("Loading from cloud...","info"),S("syncing"),e){e.disabled=!0;const c=e.querySelector(".sync-btn-text");c&&(c.textContent="Loading...")}const s=D.getConfig().environment.apiBaseUrl,o=await F.syncFromCloud(B,{apiBaseUrl:s,deviceAuth:A});if(o.success&&o.data){const c=o.data;if(u&&u.lastModified&&c.lastModified&&new Date(u.lastModified)>new Date(c.lastModified)&&!await ye(u,c)){h("Load cancelled - keeping local version","info"),S("synced");return}u=c;const r=`timetable-${B}`;await k(r,c),L(c),h("Successfully loaded from cloud!","success"),S("synced"),X(),console.log("[SIDEBAR] Manual load from cloud successful")}else if(o.error==="Presentation not found in cloud")h("No cloud version found for this presentation","info"),S("synced");else throw new Error(o.error||"Failed to load from cloud")}catch(a){console.error("[SIDEBAR] Manual load from cloud failed:",a),h(`Load failed: ${a.message}`,"error"),S("error")}finally{if(e){e.disabled=!1;const a=e.querySelector(".sync-btn-text");a&&t&&(a.textContent=t)}}}async function fe(){const e=document.getElementById("auto-sync-toggle"),t=e==null?void 0:e.querySelector(".sync-btn-text"),n=e==null?void 0:e.classList.contains("active");n?(e.classList.remove("active"),t&&(t.textContent="Auto Sync: Off"),h("Auto-sync disabled","info")):(e.classList.add("active"),t&&(t.textContent="Auto Sync: On"),h("Auto-sync enabled","success")),console.log("[SIDEBAR] Auto-sync toggled:",!n)}function h(e,t="info"){let n=document.getElementById("sync-status-message");if(!n){n=document.createElement("div"),n.id="sync-status-message",n.className="sync-status-message";const a=document.getElementById("cloud-sync-section");a&&a.appendChild(n)}n.textContent=e,n.className=`sync-status-message ${t}`,n.style.display="block",(t==="success"||t==="info")&&setTimeout(()=>{n&&(n.style.display="none")},3e3)}function S(e){const t=document.getElementById("sync-indicator");if(t)switch(t.className="sync-indicator",t.classList.add(e),e){case"synced":t.textContent="‚óè";break;case"syncing":t.textContent="‚ü≥";break;case"error":t.textContent="‚ö†";break;case"offline":t.textContent="‚óã";break;default:t.textContent="‚óè"}}function X(){const e=document.getElementById("last-sync-time");if(e){const n=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});e.textContent=`Last sync: ${n}`}}async function pe(){try{const e=await w.isAuthenticated();S(e?"synced":"offline")}catch{S("error")}}async function ye(e,t){return new Promise(n=>{const a=new Date(e.lastModified||0).toLocaleString(),s=new Date(t.lastModified||0).toLocaleString(),o=`Conflict detected:

Local version: ${a}
Cloud version: ${s}

Which version would you like to keep?`,c=confirm(`${o}

Click OK to use cloud version
Click Cancel to keep local version`);n(c)})}
