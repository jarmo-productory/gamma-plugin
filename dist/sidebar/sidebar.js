import{l as P,s as W,d as V,c as I,a as w,b as F,e as B,f as K}from"../assets/index.js";function _(e,t={}){const{startTime:n="09:00",defaultDuration:a=5,existingItems:s=[]}=t,o=new Date(`1970-01-01T${n}:00`);let c=0;const i=e.map(r=>{const d=s.find(S=>S.id===r.id),b=d?d.duration:a,m=new Date(o);o.setMinutes(o.getMinutes()+b);const p=new Date(o);return c+=b,{id:r.id,title:r.title,content:r.content,startTime:m.toTimeString().slice(0,5),endTime:p.toTimeString().slice(0,5),duration:b}});return{startTime:n,items:i,totalDuration:c}}function j(e,t,n=!1){const a=document.createElement("a");if(a.setAttribute("download",e),a.style.visibility="hidden",document.body.appendChild(a),n)a.href=t;else{const s=new Blob([t],{type:"text/csv;charset=utf-8;"});a.href=URL.createObjectURL(s)}a.click(),document.body.removeChild(a)}function G(e){var r;const t=((r=e.items[0])==null?void 0:r.title)||"Course Timetable",n=e.items.map(d=>[d.startTime,d.endTime,d.duration,d.title]),s=[[t],["Start","End","Duration","Slide title"],...n],o=XLSX.utils.aoa_to_sheet(s);o["!cols"]=[{wch:10},{wch:10},{wch:10},{wch:80}];const c=XLSX.utils.book_new();XLSX.utils.book_append_sheet(c,o,"Timetable");const i=XLSX.write(c,{bookType:"xlsx",type:"array"});return new Blob([i],{type:"application/octet-stream"})}function T(e,t){return W(e,t)}function J(e){return P(e)}function O(e,t){return V(e,t)}console.log("[SIDEBAR] Script loaded");const Q="0.0.28";let R=!1,x=[],u=null,A=null,D=null,Y=!1,Z=!1;function ee(e){if(!u){console.log("[SIDEBAR] No current timetable, generating a new one.");const s=_(e);L(s),M();return}console.log("[SIDEBAR] Reconciling new slide data with existing timetable.");const t=[],n=new Map(u.items.map(s=>[s.id,s]));for(const s of e){const o=n.get(s.id);o?t.push({...o,title:s.title,content:s.content}):t.push({...s,duration:5})}u.items=t;const a=H(u);L(a),M()}const te=async(e,t)=>{var a;if(console.log(`[SIDEBAR] updateUIWithNewSlides called for tab ${t} with`,(e==null?void 0:e.length)||0,"slides"),x=e||[],e.length===0){document.getElementById("sidebar-main").innerHTML="<p>No slides detected in this Gamma presentation.</p>",C(e,"Received: slide-data (empty)");return}const n=(a=e[0])==null?void 0:a.presentationUrl;if(n){if(n!==D){console.log(`[SIDEBAR] Switched to new presentation: ${n}. Loading from storage...`),D=n;const s=`timetable-${n}`;let o=await J(s);const c=I.getConfig();if(c.features.cloudSync&&c.environment.apiBaseUrl)try{const i=await F.syncFromCloud(n,{apiBaseUrl:c.environment.apiBaseUrl,deviceAuth:B});if(i.success&&i.data){console.log("[SIDEBAR] Found cloud version, merging with local...");const r=i.data;!o||r.lastModified&&o.lastModified&&new Date(r.lastModified)>new Date(o.lastModified)?(o=r,await T(s,r),console.log("[SIDEBAR] Using cloud version (newer than local).")):console.log("[SIDEBAR] Using local version (newer than cloud).")}else!i.success&&i.error!=="Presentation not found in cloud"&&console.warn("[SIDEBAR] Cloud sync failed:",i.error)}catch(i){console.warn("[SIDEBAR] Cloud sync error (non-critical):",i)}o?(console.log("[SIDEBAR] Found stored timetable."),u=o):(console.log("[SIDEBAR] No stored timetable, generating a new one..."),u=_(e))}ee(e),C(e,"Rendered: slide-data")}};function ne(){if(console.log("[SIDEBAR] Connecting to background script..."),A=chrome.runtime.connect({name:"sidebar"}),console.log("[SIDEBAR] Connected to background"),!A){console.error("[SIDEBAR] Failed to create port connection");return}R=!0,C(x,"Connected to background"),A.onMessage.addListener(e=>{if(console.log("[SIDEBAR] Received message from background:",e),e.type==="slide-data")te(e.slides,e.tabId);else if(e.type==="gamma-tab-activated")e.tabId,document.getElementById("sidebar-main").innerHTML="<p>Loading timetable...</p>",A.postMessage({type:"get-slides"});else if(e.type==="show-message"){document.getElementById("sidebar-main").innerHTML=`<p>${e.message}</p>`;const t=document.getElementById("timetable-title");t&&(t.textContent="Gamma Timetable");const n=document.getElementById("duration-badge");n&&(n.textContent="0h 0m")}else e.type==="error"&&(console.error("[SIDEBAR] Error from background:",e.message),document.getElementById("sidebar-main").innerHTML=`<p style="color: red;">${e.message}</p>`)}),A.onDisconnect.addListener(()=>{A=null,R=!1,console.log("[SIDEBAR] Disconnected from background script."),C(x,"Disconnected")})}function oe(e){let t="";return e.forEach(n=>{switch(n.type){case"paragraph":t+=`<p>${n.text}</p>`;break;case"image":t+=`<img src="${n.text}" class="thumbnail-img">`;break;case"link":t+=`<a href="${n.text}" target="_blank" class="content-link">${n.text}</a>`;break;case"list_item":t+=`<p>${n.text}</p>`,n.subItems&&n.subItems.length>0&&(t+='<ul class="sub-items-list">',n.subItems.forEach(a=>{t+=`<li class="sub-item">${a}</li>`}),t+="</ul>");break}}),t}function ae(e,t){const n=document.createElement("div");n.className="time-input-container";const[a,s]=e.startTime.split(":"),o=document.createElement("input");o.type="text",o.className="time-input-segment",o.value=a,o.maxLength=2,o.placeholder="00",o.inputMode="numeric";const c=document.createElement("span");c.className="time-input-separator",c.textContent=":";const i=document.createElement("input");i.type="text",i.className="time-input-segment",i.value=s,i.maxLength=2,i.placeholder="00",i.inputMode="numeric";let r=!1;const d=()=>{const l=o.value.trim(),g=i.value.trim();if(l&&g){const f=parseInt(l,10),y=parseInt(g,10);if(!isNaN(f)&&!isNaN(y)&&f>=0&&f<=23&&y>=0&&y<=59){const $=`${l.padStart(2,"0")}:${g.padStart(2,"0")}`;t($)}}},b=O(d,200),m=(l,g)=>{const f=g.target.value,y=f.replace(/[^0-9]/g,"");return y!==f&&(g.target.value=y),y},p=(l,g)=>{if(l.length===2){const f=parseInt(l,10);return!isNaN(f)&&f>=0&&f<=23}return!1},S=()=>{r=!0},v=()=>{r=!1,d()};o.addEventListener("focus",S),o.addEventListener("blur",v),i.addEventListener("focus",S),i.addEventListener("blur",v),o.addEventListener("input",l=>{const g=m(o,l);p(g)&&setTimeout(()=>i.focus(),50),b()}),o.addEventListener("keydown",l=>{if(l.key==="ArrowUp"||l.key==="ArrowDown"){l.preventDefault();const g=parseInt(o.value||"0",10),f=l.key==="ArrowUp"?1:-1,y=Math.max(0,Math.min(23,g+f));o.value=y.toString().padStart(2,"0"),b()}l.key==="Enter"&&(i.focus(),d())}),i.addEventListener("input",l=>{m(i,l),b()}),i.addEventListener("keydown",l=>{if(l.key==="ArrowUp"||l.key==="ArrowDown"){l.preventDefault();const g=parseInt(i.value||"0",10),f=l.key==="ArrowUp"?1:-1,y=Math.max(0,Math.min(59,g+f));i.value=y.toString().padStart(2,"0"),b()}l.key==="Enter"&&(d(),o.focus()),l.key==="Backspace"&&i.value===""&&o.focus()});const k=l=>{l.preventDefault();const f=l.clipboardData.getData("text").trim().match(/^(\d{1,2}):?(\d{2})$/);if(f){const[,y,$]=f,U=parseInt(y,10),N=parseInt($,10);U>=0&&U<=23&&N>=0&&N<=59&&(o.value=U.toString().padStart(2,"0"),i.value=N.toString().padStart(2,"0"),d())}};return o.addEventListener("paste",k),i.addEventListener("paste",k),n.appendChild(o),n.appendChild(c),n.appendChild(i),n._hasFocus=()=>r,n}function ie(e=[],t="none",n={}){const{authFeatureEnabled:a=!1,isAuthenticated:s=!1,userEmail:o=""}=n,{debugMode:c=!1}=n,i=e.length,r=e[0]?JSON.stringify(e[0],null,2):"N/A",d=a,b=d&&c?s?`<div style="margin-top:6px;"><span>Logged in as <strong>${o||"user"}</strong></span> <button id="debug-logout-btn" class="export-btn" style="margin-left:8px;">Logout</button></div>`:'<div style="margin-top:6px;"><button id="debug-login-btn" class="export-btn">Login</button></div>':"";return`
        <strong>Debug Info (v${Q})</strong><br>
        Auth Feature: <strong style="color: ${d?"green":"red"}">${d?"ENABLED":"DISABLED"}</strong><br>
        Slides Detected: <strong>${i}</strong><br>
        Connection Status: <span style="color:${R?"green":"red"};font-weight:bold;">${R?"Connected":"Disconnected"}</span><br>
        Last Action: <span style="font-family: monospace;">${t}</span><br>
        ${b}
        <details><summary>First Slide Preview</summary><pre>${r}</pre></details>
    `}async function C(e=[],t="none"){const n=document.getElementById("debug-info");if(!n)return;const a=I.isFeatureEnabled("authentication"),s=I.isFeatureEnabled("debugMode");let o=!1,c="";if(a)try{o=await w.isAuthenticated();const d=await w.getCurrentUser();c=(d==null?void 0:d.email)||""}catch{}n.innerHTML=ie(e,t,{authFeatureEnabled:a,isAuthenticated:o,userEmail:c,debugMode:s});const i=document.getElementById("debug-login-btn");i&&i.addEventListener("click",async()=>{console.log("[SIDEBAR] Debug login button clicked"),await w.login()});const r=document.getElementById("debug-logout-btn");r&&r.addEventListener("click",async()=>{console.log("[SIDEBAR] Debug logout button clicked"),await w.logout()})}function L(e){var b;u=e;const t=document.getElementById("sidebar-main");if(!t)return;const n=document.getElementById("timetable-title");n&&(n.textContent=((b=e.items[0])==null?void 0:b.title)||"Course Timetable");const a=document.getElementById("duration-badge");if(a){const m=Math.floor(e.totalDuration/60),p=e.totalDuration%60;a.textContent=`${m}h ${p}m`}const s=document.getElementById("functions-toolbar");if(!s)return;s.innerHTML="";const o=document.createElement("div");o.className="time-display-section";const c=ae(e,m=>{u.startTime=m;const p=H(u);(!c._hasFocus||!c._hasFocus())&&L(p),M()});o.prepend(c),s.appendChild(o);const i=document.createElement("div");i.className="export-options",i.innerHTML=`
    <button id="export-xlsx-btn" class="export-btn"><img src="/assets/xlsx.svg" alt="Excel">Excel</button>
    <button id="auth-login-toolbar-btn" class="export-btn"><span>üîê</span><span id="auth-toolbar-text">Login</span></button>
  `,s.appendChild(i),t.innerHTML="",i.querySelector("#export-xlsx-btn").onclick=()=>{if(!u)return;const m=G(u),p=`gamma-timetable-${new Date().toISOString().slice(0,10)}.xlsx`,S=URL.createObjectURL(m);j(p,S,!0)};const r=i.querySelector("#auth-login-toolbar-btn"),d=i.querySelector("#auth-toolbar-text");if(r&&d){const m=async()=>{await w.isAuthenticated()?(d.textContent="Logout",r.onclick=async()=>{console.log("[SIDEBAR] Toolbar logout button clicked"),await w.logout(),await m()}):(d.textContent="Login",r.onclick=async()=>{var S;console.log("[SIDEBAR] Toolbar login button clicked (web-first pairing)");try{const v=I.getConfig(),k=v.environment.apiBaseUrl||"http://localhost:3000",l=v.environment.webBaseUrl||"http://localhost:3000",g=await B.registerDevice(k),f=B.buildSignInUrl(l,g.code);(S=chrome==null?void 0:chrome.tabs)!=null&&S.create?chrome.tabs.create({url:f}):window!=null&&window.open&&window.open(f,"_blank"),await B.pollExchangeUntilLinked(k,g.deviceId,g.code)?(console.log("[SIDEBAR] Device linked; token stored."),await m()):console.warn("[SIDEBAR] Device linking timed out.")}catch(v){console.error("[SIDEBAR] Web-first login failed:",v)}})};m()}e.items.forEach(m=>{const p=document.createElement("div");p.className="slide-item";const S=oe(m.content);p.innerHTML=`
      <div class="slide-item-header">
        <h3 class="slide-item__title">${m.title}</h3>
        <div class="slide-item-time">
          ${m.startTime} - ${m.endTime}
        </div>
      </div>
      <div class="duration-slider-container">
        <input type="range" min="0" max="60" value="${m.duration}" class="duration-slider" data-slide-id="${m.id}">
        <span class="duration-display">${parseInt(m.duration,10)} min</span>
      </div>
      <div class="slide-item-content">${S}</div>
    `,t.appendChild(p)}),t.querySelectorAll(".duration-slider").forEach(m=>{m.addEventListener("input",se),m.addEventListener("change",ce)})}const M=O(async()=>{var e;if(u&&D){const t=`timetable-${D}`;try{const n=I.getConfig(),a=n.environment.apiBaseUrl;n.features.cloudSync&&a?(await K(t,u,{deviceAuth:B,apiBaseUrl:a,title:u.title||((e=x[0])==null?void 0:e.title)||"Untitled Presentation",enableAutoSync:!0}),console.log("[SIDEBAR] Timetable saved with cloud sync.")):(await T(t,u),console.log("[SIDEBAR] Timetable saved (local only)."))}catch(n){console.error("[SIDEBAR] Save failed:",n);try{await T(t,u),console.log("[SIDEBAR] Timetable saved (fallback to local).")}catch(a){console.error("[SIDEBAR] Fallback save also failed:",a)}}}},500);function se(e){const t=parseInt(e.target.value,10),n=e.target.nextElementSibling;n&&(n.textContent=`${t} min`)}function ce(e){const t=e.target.getAttribute("data-slide-id"),n=parseInt(e.target.value,10),a=u.items.find(o=>o.id===t);if(a){a.duration=n;const o=H(u);L(o),M()}const s=e.target.nextElementSibling;s&&(s.textContent=`${n} min`)}function H(e){const t=new Date(`1970-01-01T${e.startTime}:00`);let n=0;const a=e.items.map(s=>{const o=new Date(t),c=s.duration;t.setMinutes(t.getMinutes()+c);const i=new Date(t);return n+=c,{...s,startTime:o.toTimeString().slice(0,5),endTime:i.toTimeString().slice(0,5)}});return{...e,items:a,totalDuration:n}}document.addEventListener("DOMContentLoaded",async()=>{console.log("[SIDEBAR] DOMContentLoaded fired"),await le(),ne()});async function le(){try{console.log("[SIDEBAR] Initializing infrastructure..."),await I.initialize(),Z=!0,console.log("[SIDEBAR] ConfigManager initialized"),await w.initialize(),Y=!0,console.log("[SIDEBAR] AuthManager initialized"),console.log("[SIDEBAR] Clerk key present at build:",!0),await re(),de(),C([],"Infrastructure ready"),console.log("[SIDEBAR] Infrastructure ready")}catch(e){console.error("[SIDEBAR] Failed to initialize infrastructure:",e),console.log("[SIDEBAR] Continuing in fallback mode...")}}async function re(){await q(),await X()}async function q(){const e=document.getElementById("auth-status-bar");if(!e)return;if(!(await I.getConfig()).features.authentication){e.style.display="none";return}e.style.display="none"}function de(){w.addEventListener(async e=>{console.log("[SIDEBAR] Auth state changed:",e.type),await q(),await X(),C(x,`Auth event: ${e.type}`)})}async function X(){const e=document.getElementById("cloud-sync-section");if(!e)return;const t=I.getConfig();if(!(t.features.cloudSync&&t.environment.apiBaseUrl)){e.style.display="none";return}try{if(await w.isAuthenticated()){e.style.display="block";const s=document.getElementById("save-to-cloud-btn"),o=document.getElementById("load-from-cloud-btn"),c=document.getElementById("auto-sync-toggle");s&&(s.disabled=!1),o&&(o.disabled=!1),c&&(c.disabled=!1),ue(),await pe()}else e.style.display="none"}catch(a){console.warn("[SIDEBAR] Failed to check auth state for sync controls:",a),e.style.display="none"}}function ue(){const e=document.getElementById("save-to-cloud-btn"),t=document.getElementById("load-from-cloud-btn"),n=document.getElementById("auto-sync-toggle");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",me),e.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("click",fe),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("click",ge),n.dataset.listenerAttached="true")}async function me(){var n,a;if(!u||!D){h("No presentation data to save","error");return}const e=document.getElementById("save-to-cloud-btn"),t=(n=e==null?void 0:e.querySelector(".sync-btn-text"))==null?void 0:n.textContent;try{if(h("Saving to cloud...","info"),E("syncing"),e){e.disabled=!0;const i=e.querySelector(".sync-btn-text");i&&(i.textContent="Saving...")}const o=I.getConfig().environment.apiBaseUrl,c=await F.syncToCloud(D,u,{apiBaseUrl:o,deviceAuth:B,title:u.title||((a=x[0])==null?void 0:a.title)||"Untitled Presentation"});if(c.success)h("Successfully saved to cloud!","success"),E("synced"),z(),console.log("[SIDEBAR] Manual save to cloud successful");else throw new Error(c.error||"Failed to save to cloud")}catch(s){console.error("[SIDEBAR] Manual save to cloud failed:",s),h(`Save failed: ${s.message}`,"error"),E("error")}finally{if(e){e.disabled=!1;const s=e.querySelector(".sync-btn-text");s&&t&&(s.textContent=t)}}}async function fe(){var n;if(!D){h("No presentation to load","error");return}const e=document.getElementById("load-from-cloud-btn"),t=(n=e==null?void 0:e.querySelector(".sync-btn-text"))==null?void 0:n.textContent;try{if(h("Loading from cloud...","info"),E("syncing"),e){e.disabled=!0;const c=e.querySelector(".sync-btn-text");c&&(c.textContent="Loading...")}const s=I.getConfig().environment.apiBaseUrl,o=await F.syncFromCloud(D,{apiBaseUrl:s,deviceAuth:B});if(o.success&&o.data){const c=o.data;if(u&&u.lastModified&&c.lastModified&&new Date(u.lastModified)>new Date(c.lastModified)&&!await ye(u,c)){h("Load cancelled - keeping local version","info"),E("synced");return}u=c;const r=`timetable-${D}`;await T(r,c),L(c),h("Successfully loaded from cloud!","success"),E("synced"),z(),console.log("[SIDEBAR] Manual load from cloud successful")}else if(o.error==="Presentation not found in cloud")h("No cloud version found for this presentation","info"),E("synced");else throw new Error(o.error||"Failed to load from cloud")}catch(a){console.error("[SIDEBAR] Manual load from cloud failed:",a),h(`Load failed: ${a.message}`,"error"),E("error")}finally{if(e){e.disabled=!1;const a=e.querySelector(".sync-btn-text");a&&t&&(a.textContent=t)}}}async function ge(){const e=document.getElementById("auto-sync-toggle"),t=e==null?void 0:e.querySelector(".sync-btn-text"),n=e==null?void 0:e.classList.contains("active");n?(e.classList.remove("active"),t&&(t.textContent="Auto Sync: Off"),h("Auto-sync disabled","info")):(e.classList.add("active"),t&&(t.textContent="Auto Sync: On"),h("Auto-sync enabled","success")),console.log("[SIDEBAR] Auto-sync toggled:",!n)}function h(e,t="info"){let n=document.getElementById("sync-status-message");if(!n){n=document.createElement("div"),n.id="sync-status-message",n.className="sync-status-message";const a=document.getElementById("cloud-sync-section");a&&a.appendChild(n)}n.textContent=e,n.className=`sync-status-message ${t}`,n.style.display="block",(t==="success"||t==="info")&&setTimeout(()=>{n&&(n.style.display="none")},3e3)}function E(e){const t=document.getElementById("sync-indicator");if(t)switch(t.className="sync-indicator",t.classList.add(e),e){case"synced":t.textContent="‚óè";break;case"syncing":t.textContent="‚ü≥";break;case"error":t.textContent="‚ö†";break;case"offline":t.textContent="‚óã";break;default:t.textContent="‚óè"}}function z(){const e=document.getElementById("last-sync-time");if(e){const n=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});e.textContent=`Last sync: ${n}`}}async function pe(){try{const e=await w.isAuthenticated();E(e?"synced":"offline")}catch{E("error")}}async function ye(e,t){return new Promise(n=>{const a=new Date(e.lastModified||0).toLocaleString(),s=new Date(t.lastModified||0).toLocaleString(),o=`Conflict detected:

Local version: ${a}
Cloud version: ${s}

Which version would you like to keep?`,c=confirm(`${o}

Click OK to use cloud version
Click Cancel to keep local version`);n(c)})}
