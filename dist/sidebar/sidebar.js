function I(n,e={}){const{startTime:t="09:00",defaultDuration:o=5,breakAfter:i=60,breakDuration:r=10,existingItems:c=[]}=e;let s=new Date(`1970-01-01T${t}:00`),m=0;const u=n.map(g=>{const p=c.find($=>$.id===g.id),a=p?p.duration:o,d=new Date(s);s.setMinutes(s.getMinutes()+a);const f=new Date(s);return m+=a,{id:g.id,title:g.title,content:g.content,startTime:d.toTimeString().slice(0,5),endTime:f.toTimeString().slice(0,5),duration:a}});return{startTime:t,items:u,totalDuration:m}}function D(n){let e=`Item,Start Time,Duration (min),End Time
`;return n.items.forEach(t=>{const o=t.title.replace(/"/g,'""');e+=`"${o}",${t.startTime},${t.duration},${t.endTime}
`}),e}function w(n,e,t=!1){const o=document.createElement("a");if(o.setAttribute("download",n),o.style.visibility="hidden",document.body.appendChild(o),t)o.href=e;else{const i=new Blob([e],{type:"text/csv;charset=utf-8;"});o.href=URL.createObjectURL(i)}o.click(),document.body.removeChild(o)}function L(n){var m;const e=((m=n.items[0])==null?void 0:m.title)||"Course Timetable",t=n.items.map(u=>[u.startTime,u.endTime,u.duration,u.title]),i=[[e],["Start","End","Duration","Slide title"],...t],r=XLSX.utils.aoa_to_sheet(i);r["!cols"]=[{wch:10},{wch:10},{wch:10},{wch:80}];const c=XLSX.utils.book_new();XLSX.utils.book_append_sheet(c,r,"Timetable");const s=XLSX.write(c,{bookType:"xlsx",type:"array"});return new Blob([s],{type:"application/octet-stream"})}function B(n){return navigator.clipboard.writeText(n)}const M={enableCloudSync:!1,syncDebounceMs:500,maxRetries:3,dataVersion:1};class R{constructor(e={}){this.syncQueue=[],this.config={...M,...e}}async save(e,t){try{const o={version:this.config.dataVersion,data:t,timestamp:new Date,presentation_url:this.extractPresentationUrl(e)};await this.chromeStorageSave(e,o),this.config.enableCloudSync&&this.addToSyncQueue(e,t,"save")}catch(o){throw console.error("[StorageManager] Save failed:",o),o}}async load(e){try{const t=await this.chromeStorageLoad(e);if(!t)return;if(!this.isVersionedData(t))return console.log("[StorageManager] Loading legacy data for key:",e),t;const o=t;return o.version!==this.config.dataVersion&&console.log(`[StorageManager] Data version mismatch for key ${e}: ${o.version} vs ${this.config.dataVersion}`),o.data}catch(t){throw console.error("[StorageManager] Load failed:",t),t}}async remove(e){try{await this.chromeStorageRemove(e),this.config.enableCloudSync&&this.addToSyncQueue(e,null,"remove")}catch(t){throw console.error("[StorageManager] Remove failed:",t),t}}async clear(){try{await this.chromeStorageClear(),this.syncQueue=[]}catch(e){throw console.error("[StorageManager] Clear failed:",e),e}}chromeStorageSave(e,t){return new Promise((o,i)=>{chrome.storage.local.set({[e]:t},()=>{if(chrome.runtime.lastError)return i(chrome.runtime.lastError);o()})})}chromeStorageLoad(e){return new Promise((t,o)=>{chrome.storage.local.get(e,i=>{if(chrome.runtime.lastError)return o(chrome.runtime.lastError);t(i[e])})})}chromeStorageRemove(e){return new Promise((t,o)=>{chrome.storage.local.remove(e,()=>{if(chrome.runtime.lastError)return o(chrome.runtime.lastError);t()})})}chromeStorageClear(){return new Promise((e,t)=>{chrome.storage.local.clear(()=>{if(chrome.runtime.lastError)return t(chrome.runtime.lastError);e()})})}isVersionedData(e){return e&&typeof e=="object"&&"version"in e&&"data"in e&&"timestamp"in e}extractPresentationUrl(e){const t=e.match(/^timetable-(.+)$/);return t?t[1]:void 0}addToSyncQueue(e,t,o){const i={key:e,data:t,operation:o,timestamp:new Date,attempts:0};this.syncQueue.push(i),this.scheduleSyncProcess()}scheduleSyncProcess(){this.syncTimer&&clearTimeout(this.syncTimer),this.syncTimer=setTimeout(()=>{this.processSyncQueue()},this.config.syncDebounceMs)}async processSyncQueue(){if(!(!this.config.enableCloudSync||this.syncQueue.length===0)){console.log(`[StorageManager] Processing sync queue: ${this.syncQueue.length} items`);for(const e of this.syncQueue)console.log("[StorageManager] Sync queue item:",e);this.syncQueue=[]}}getSyncQueueStatus(){return{count:this.syncQueue.length,items:[...this.syncQueue]}}updateConfig(e){this.config={...this.config,...e}}}const x=new R;function A(n,e){return x.save(n,e)}function k(n){return x.load(n)}function H(n,e){let t;return function(...o){const i=this;clearTimeout(t),t=setTimeout(()=>n.apply(i,o),e)}}function N(n,e){return A(n,e)}function Q(n){return k(n)}function C(n,e){return H(n,e)}console.log("[SIDEBAR] Script loaded");const U="0.0.7";let y=!1,l=null,h=null,v=null;function X(n){if(!l){console.log("[SIDEBAR] No current timetable, generating a new one.");const i=I(n);S(i),T();return}console.log("[SIDEBAR] Reconciling new slide data with existing timetable.");const e=[],t=new Map(l.items.map(i=>[i.id,i]));new Map(n.map(i=>[i.id,i]));for(const i of n){const r=t.get(i.id);r?e.push({...r,title:i.title,content:i.content}):e.push({...i,duration:5})}l.items=e;const o=E(l);S(o),T()}const _=async(n,e)=>{var i;console.log(`[SIDEBAR] updateUIWithNewSlides called for tab ${e} with`,(n==null?void 0:n.length)||0,"slides");const t=document.getElementById("sidebar-footer");if(n.length===0){document.getElementById("sidebar-main").innerHTML="<p>No slides detected in this Gamma presentation.</p>",t&&(t.innerHTML=b(n,"Received: slide-data (empty)"));return}const o=(i=n[0])==null?void 0:i.presentationUrl;if(o){if(o!==v){console.log(`[SIDEBAR] Switched to new presentation: ${o}. Loading from storage...`),v=o;const r=`timetable-${o}`,c=await Q(r);c?(console.log("[SIDEBAR] Found stored timetable."),l=c):(console.log("[SIDEBAR] No stored timetable, generating a new one..."),l=I(n))}X(n),t&&(t.innerHTML=b(n,"Rendered: slide-data"))}};function O(){if(console.log("[SIDEBAR] Connecting to background script..."),h=chrome.runtime.connect({name:"sidebar"}),console.log("[SIDEBAR] Connected to background"),!h){console.error("[SIDEBAR] Failed to create port connection");return}y=!0;const n=document.getElementById("sidebar-footer");n&&(n.innerHTML=b([],"Connected to background")),h.onMessage.addListener(e=>{var t;if(console.log("[SIDEBAR] Received message from background:",e),e.type==="slide-data")console.log("[SIDEBAR] Received slide-data for tab",e.tabId,"with",((t=e.slides)==null?void 0:t.length)||0,"slides"),_(e.slides,e.tabId);else if(e.type==="gamma-tab-activated")console.log(`[SIDEBAR] Gamma tab ${e.tabId} activated. Requesting new slides.`),e.tabId,document.getElementById("sidebar-main").innerHTML="<p>Loading timetable...</p>",h.postMessage({type:"get-slides"});else if(e.type==="show-message"){console.log(`[SIDEBAR] Displaying message: ${e.message}`),document.getElementById("sidebar-main").innerHTML=`<p>${e.message}</p>`;const o=document.getElementById("timetable-title");o&&(o.textContent="Gamma Timetable");const i=document.getElementById("duration-badge");i&&(i.textContent="0h 0m")}else if(e.type==="error"){console.error("[SIDEBAR] Error from background:",e.message),document.getElementById("sidebar-main").innerHTML=`<p style="color: red;">${e.message}</p>`;const o=document.getElementById("sidebar-footer");o&&(o.innerHTML=b([],"Error: "+e.message))}}),h.onDisconnect.addListener(()=>{h=null,y=!1,console.log("[SIDEBAR] Disconnected from background script.");const e=document.getElementById("sidebar-footer");e&&(e.innerHTML=b([],"Disconnected"))})}function P(n){let e="";return n.forEach(t=>{switch(t.type){case"paragraph":e+=`<p>${t.text}</p>`;break;case"image":e+=`<img src="${t.text}" class="thumbnail-img">`;break;case"link":e+=`<a href="${t.text}" target="_blank" class="content-link">${t.text}</a>`;break;case"list_item":e+=`<p>${t.text}</p>`,t.subItems&&t.subItems.length>0&&(e+='<ul class="sub-items-list">',t.subItems.forEach(o=>{e+=`<li class="sub-item">${o}</li>`}),e+="</ul>");break}}),e}function V(n,e){const t=document.createElement("div");t.className="time-input-container";const[o,i]=n.startTime.split(":"),r=document.createElement("input");r.type="text",r.className="time-input-segment",r.value=o,r.maxLength=2,r.placeholder="00";const c=document.createElement("span");c.className="time-input-separator",c.textContent=":";const s=document.createElement("input");s.type="text",s.className="time-input-segment",s.value=i,s.maxLength=2,s.placeholder="00";const u=C(()=>{const g=r.value.padStart(2,"0"),p=s.value.padStart(2,"0"),a=parseInt(g,10),d=parseInt(p,10);a>=0&&a<=23&&d>=0&&d<=59&&e(`${g}:${p}`)},400);return r.addEventListener("input",()=>{r.value.length>=2&&(r.value=r.value.slice(0,2),s.focus()),u()}),s.addEventListener("input",()=>{s.value.length>=2&&(s.value=s.value.slice(0,2)),u()}),t.appendChild(r),t.appendChild(c),t.appendChild(s),t}function b(n=[],e="none"){const t=n.length;let o=n[0]?JSON.stringify(n[0],null,2):"N/A";return`
    <div class="debug-info">
      <strong>Debug Info (v${U})</strong><br>
      Slides Detected: <strong>${t}</strong><br>
      Connection Status: <span style="color:${y?"green":"red"};font-weight:bold;">${y?"Connected":"Disconnected"}</span><br>
      Last Action: <span style="font-family: monospace;">${e}</span><br>
      <details><summary>First Slide Preview</summary><pre>${o}</pre></details>
    </div>
  `}function S(n){var p;l=n;const e=document.getElementById("sidebar-main");if(!e)return;const t=document.getElementById("timetable-title");t&&(t.textContent=((p=n.items[0])==null?void 0:p.title)||"Course Timetable");const o=document.getElementById("duration-badge");if(o){const a=Math.floor(n.totalDuration/60),d=n.totalDuration%60;o.textContent=`${a}h ${d}m`}const i=document.getElementById("functions-toolbar");if(!i)return;i.innerHTML="";const r=document.createElement("div");r.className="time-display-section",r.prepend(V(n,a=>{l.startTime=a;const d=E(l);S(d),T()})),i.appendChild(r);const c=document.createElement("div");c.className="export-options",c.innerHTML=`
    <button id="export-csv-btn" class="export-btn"><img src="/assets/csv.svg" alt="CSV">CSV</button>
    <button id="export-xlsx-btn" class="export-btn"><img src="/assets/xlsx.svg" alt="Excel">Excel</button>
    <button id="copy-clipboard-btn" class="export-btn copy-btn-icon-only"><img src="/assets/copy.svg" alt="Copy"></button>
  `,i.appendChild(c),e.innerHTML="";const s=c.querySelector("#export-csv-btn");s.onclick=()=>{if(!l)return;const a=D(l),d=`gamma-timetable-${new Date().toISOString().slice(0,10)}.csv`;w(d,a)};const m=c.querySelector("#export-xlsx-btn");m.onclick=()=>{if(!l)return;const a=L(l),d=`gamma-timetable-${new Date().toISOString().slice(0,10)}.xlsx`,f=URL.createObjectURL(a);w(d,f,!0)};const u=c.querySelector("#copy-clipboard-btn");u.onclick=()=>{if(!l)return;const a=D(l);B(a).then(()=>{u.classList.add("copied"),setTimeout(()=>{u.classList.remove("copied")},2e3)})},n.items.forEach(a=>{const d=document.createElement("div");d.className="slide-item";const f=P(a.content);d.innerHTML=`
      <div class="slide-item-header">
        <h3 class="slide-item__title">${a.title}</h3>
        <div class="slide-item-time">
          ${a.startTime} - ${a.endTime}
        </div>
      </div>
      <div class="duration-slider-container">
        <input type="range" min="0" max="60" value="${a.duration}" class="duration-slider" data-slide-id="${a.id}">
        <span class="duration-display">${parseInt(a.duration,10)} min</span>
      </div>
      <div class="slide-item-content">${f}</div>
    `,e.appendChild(d)}),e.querySelectorAll(".duration-slider").forEach(a=>{a.addEventListener("input",q),a.addEventListener("change",F)})}const T=C(async()=>{if(l){const n=`timetable-${v}`;N(n,l),console.log("Timetable saved.")}},500);function q(n){const e=parseInt(n.target.value,10),t=n.target.nextElementSibling;t&&(t.textContent=`${e} min`)}function F(n){const e=n.target.getAttribute("data-slide-id"),t=parseInt(n.target.value,10),o=l.items.find(r=>r.id===e);if(o){o.duration=t;const r=E(l);S(r),T()}const i=n.target.nextElementSibling;i&&(i.textContent=`${t} min`)}function E(n){let e=new Date(`1970-01-01T${n.startTime}:00`),t=0;const o=n.items.map(i=>{const r=new Date(e),c=i.duration;e.setMinutes(e.getMinutes()+c);const s=new Date(e);return t+=c,{...i,startTime:r.toTimeString().slice(0,5),endTime:s.toTimeString().slice(0,5)}});return{...n,items:o,totalDuration:t}}document.addEventListener("DOMContentLoaded",async()=>{console.log("[SIDEBAR] DOMContentLoaded fired"),O()});
