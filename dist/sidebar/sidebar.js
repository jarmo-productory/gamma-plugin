import{l as M,d as U,s as N,c as y,a as b,b as D}from"../assets/index.js";function k(t,n={}){const{startTime:e="09:00",defaultDuration:a=5,existingItems:i=[]}=n,o=new Date(`1970-01-01T${e}:00`);let l=0;const r=t.map(d=>{const c=i.find(m=>m.id===d.id),p=c?c.duration:a,s=new Date(o);o.setMinutes(o.getMinutes()+p);const u=new Date(o);return l+=p,{id:d.id,title:d.title,content:d.content,startTime:s.toTimeString().slice(0,5),endTime:u.toTimeString().slice(0,5),duration:p}});return{startTime:e,items:r,totalDuration:l}}function H(t,n,e=!1){const a=document.createElement("a");if(a.setAttribute("download",t),a.style.visibility="hidden",document.body.appendChild(a),e)a.href=n;else{const i=new Blob([n],{type:"text/csv;charset=utf-8;"});a.href=URL.createObjectURL(i)}a.click(),document.body.removeChild(a)}function F(t){var d;const n=((d=t.items[0])==null?void 0:d.title)||"Course Timetable",e=t.items.map(c=>[c.startTime,c.endTime,c.duration,c.title]),i=[[n],["Start","End","Duration","Slide title"],...e],o=XLSX.utils.aoa_to_sheet(i);o["!cols"]=[{wch:10},{wch:10},{wch:10},{wch:80}];const l=XLSX.utils.book_new();XLSX.utils.book_append_sheet(l,o,"Timetable");const r=XLSX.write(l,{bookType:"xlsx",type:"array"});return new Blob([r],{type:"application/octet-stream"})}function X(t,n){return N(t,n)}function _(t){return M(t)}function C(t,n){return U(t,n)}console.log("[SIDEBAR] Script loaded");const z="0.0.26";let S=!1,I=[],g=null,E=null,v=null,O=!1,P=!1;function q(t){if(!g){console.log("[SIDEBAR] No current timetable, generating a new one.");const i=k(t);w(i),T();return}console.log("[SIDEBAR] Reconciling new slide data with existing timetable.");const n=[],e=new Map(g.items.map(i=>[i.id,i]));for(const i of t){const o=e.get(i.id);o?n.push({...o,title:i.title,content:i.content}):n.push({...i,duration:5})}g.items=n;const a=x(g);w(a),T()}const j=async(t,n)=>{var a;if(console.log(`[SIDEBAR] updateUIWithNewSlides called for tab ${n} with`,(t==null?void 0:t.length)||0,"slides"),I=t||[],t.length===0){document.getElementById("sidebar-main").innerHTML="<p>No slides detected in this Gamma presentation.</p>",f(t,"Received: slide-data (empty)");return}const e=(a=t[0])==null?void 0:a.presentationUrl;if(e){if(e!==v){console.log(`[SIDEBAR] Switched to new presentation: ${e}. Loading from storage...`),v=e;const i=`timetable-${e}`,o=await _(i);o?(console.log("[SIDEBAR] Found stored timetable."),g=o):(console.log("[SIDEBAR] No stored timetable, generating a new one..."),g=k(t))}q(t),f(t,"Rendered: slide-data")}};function G(){if(console.log("[SIDEBAR] Connecting to background script..."),E=chrome.runtime.connect({name:"sidebar"}),console.log("[SIDEBAR] Connected to background"),!E){console.error("[SIDEBAR] Failed to create port connection");return}S=!0,f(I,"Connected to background"),E.onMessage.addListener(t=>{if(console.log("[SIDEBAR] Received message from background:",t),t.type==="slide-data")j(t.slides,t.tabId);else if(t.type==="gamma-tab-activated")t.tabId,document.getElementById("sidebar-main").innerHTML="<p>Loading timetable...</p>",E.postMessage({type:"get-slides"});else if(t.type==="show-message"){document.getElementById("sidebar-main").innerHTML=`<p>${t.message}</p>`;const n=document.getElementById("timetable-title");n&&(n.textContent="Gamma Timetable");const e=document.getElementById("duration-badge");e&&(e.textContent="0h 0m")}else t.type==="error"&&(console.error("[SIDEBAR] Error from background:",t.message),document.getElementById("sidebar-main").innerHTML=`<p style="color: red;">${t.message}</p>`)}),E.onDisconnect.addListener(()=>{E=null,S=!1,console.log("[SIDEBAR] Disconnected from background script."),f(I,"Disconnected")})}function K(t){let n="";return t.forEach(e=>{switch(e.type){case"paragraph":n+=`<p>${e.text}</p>`;break;case"image":n+=`<img src="${e.text}" class="thumbnail-img">`;break;case"link":n+=`<a href="${e.text}" target="_blank" class="content-link">${e.text}</a>`;break;case"list_item":n+=`<p>${e.text}</p>`,e.subItems&&e.subItems.length>0&&(n+='<ul class="sub-items-list">',e.subItems.forEach(a=>{n+=`<li class="sub-item">${a}</li>`}),n+="</ul>");break}}),n}function W(t,n){const e=document.createElement("div");e.className="time-input-container";const[a,i]=t.startTime.split(":"),o=document.createElement("input");o.type="text",o.className="time-input-segment",o.value=a,o.maxLength=2,o.placeholder="00";const l=document.createElement("span");l.className="time-input-separator",l.textContent=":";const r=document.createElement("input");r.type="text",r.className="time-input-segment",r.value=i,r.maxLength=2,r.placeholder="00";const c=C(()=>{const p=o.value.padStart(2,"0"),s=r.value.padStart(2,"0"),u=parseInt(p,10),m=parseInt(s,10);u>=0&&u<=23&&m>=0&&m<=59&&n(`${p}:${s}`)},400);return o.addEventListener("input",()=>{o.value.length>=2&&(o.value=o.value.slice(0,2),r.focus()),c()}),r.addEventListener("input",()=>{r.value.length>=2&&(r.value=r.value.slice(0,2)),c()}),e.appendChild(o),e.appendChild(l),e.appendChild(r),e}function J(t=[],n="none",e={}){const{authFeatureEnabled:a=!1,isAuthenticated:i=!1,userEmail:o=""}=e,{debugMode:l=!1}=e,r=t.length,d=t[0]?JSON.stringify(t[0],null,2):"N/A",c=a,p=c&&l?i?`<div style="margin-top:6px;"><span>Logged in as <strong>${o||"user"}</strong></span> <button id="debug-logout-btn" class="export-btn" style="margin-left:8px;">Logout</button></div>`:'<div style="margin-top:6px;"><button id="debug-login-btn" class="export-btn">Login</button></div>':"";return`
        <strong>Debug Info (v${z})</strong><br>
        Auth Feature: <strong style="color: ${c?"green":"red"}">${c?"ENABLED":"DISABLED"}</strong><br>
        Slides Detected: <strong>${r}</strong><br>
        Connection Status: <span style="color:${S?"green":"red"};font-weight:bold;">${S?"Connected":"Disconnected"}</span><br>
        Last Action: <span style="font-family: monospace;">${n}</span><br>
        ${p}
        <details><summary>First Slide Preview</summary><pre>${d}</pre></details>
    `}async function f(t=[],n="none"){const e=document.getElementById("debug-info");if(!e)return;const a=y.isFeatureEnabled("authentication"),i=y.isFeatureEnabled("debugMode");let o=!1,l="";if(a)try{o=await b.isAuthenticated();const c=await b.getCurrentUser();l=(c==null?void 0:c.email)||""}catch{}e.innerHTML=J(t,n,{authFeatureEnabled:a,isAuthenticated:o,userEmail:l,debugMode:i});const r=document.getElementById("debug-login-btn");r&&r.addEventListener("click",async()=>{console.log("[SIDEBAR] Debug login button clicked"),await b.login()});const d=document.getElementById("debug-logout-btn");d&&d.addEventListener("click",async()=>{console.log("[SIDEBAR] Debug logout button clicked"),await b.logout()})}function w(t){var p;g=t;const n=document.getElementById("sidebar-main");if(!n)return;const e=document.getElementById("timetable-title");e&&(e.textContent=((p=t.items[0])==null?void 0:p.title)||"Course Timetable");const a=document.getElementById("duration-badge");if(a){const s=Math.floor(t.totalDuration/60),u=t.totalDuration%60;a.textContent=`${s}h ${u}m`}const i=document.getElementById("functions-toolbar");if(!i)return;i.innerHTML="";const o=document.createElement("div");o.className="time-display-section",o.prepend(W(t,s=>{g.startTime=s;const u=x(g);w(u),T()})),i.appendChild(o);const l=document.createElement("div");l.className="export-options",l.innerHTML=`
    <button id="export-xlsx-btn" class="export-btn"><img src="/assets/xlsx.svg" alt="Excel">Excel</button>
    <button id="auth-login-toolbar-btn" class="export-btn"><span>üîê</span><span id="auth-toolbar-text">Login</span></button>
    <button id="test-api-btn" class="export-btn">Test API</button>
  `,i.appendChild(l),n.innerHTML="",l.querySelector("#export-xlsx-btn").onclick=()=>{if(!g)return;const s=F(g),u=`gamma-timetable-${new Date().toISOString().slice(0,10)}.xlsx`,m=URL.createObjectURL(s);H(u,m,!0)};const r=l.querySelector("#auth-login-toolbar-btn"),d=l.querySelector("#auth-toolbar-text"),c=l.querySelector("#test-api-btn");if(r&&d){const s=async()=>{await b.isAuthenticated()?(d.textContent="Logout",r.onclick=async()=>{console.log("[SIDEBAR] Toolbar logout button clicked"),await b.logout(),await s()}):(d.textContent="Login",r.onclick=async()=>{var m;console.log("[SIDEBAR] Toolbar login button clicked (web-first pairing)");try{const h=y.getConfig(),A=h.environment.apiBaseUrl||"http://localhost:3000",R=h.environment.webBaseUrl||"http://localhost:3000",B=await D.registerDevice(A),L=D.buildSignInUrl(R,B.code);(m=chrome==null?void 0:chrome.tabs)!=null&&m.create?chrome.tabs.create({url:L}):window!=null&&window.open&&window.open(L,"_blank"),await D.pollExchangeUntilLinked(A,B.deviceId,B.code)?(console.log("[SIDEBAR] Device linked; token stored."),await s()):console.warn("[SIDEBAR] Device linking timed out.")}catch(h){console.error("[SIDEBAR] Web-first login failed:",h)}})};s()}c&&(c.onclick=async()=>{try{const u=y.getConfig().environment.apiBaseUrl||"http://localhost:3000",m=await D.authorizedFetch(u,"/api/protected/ping",{method:"GET"});if(!m.ok)throw new Error(`status ${m.status}`);const h=await m.json();console.log("[SIDEBAR] Protected ping OK:",h),f(I,"Protected ping OK")}catch(s){console.error("[SIDEBAR] Protected ping failed:",s),f(I,"Protected ping failed")}}),t.items.forEach(s=>{const u=document.createElement("div");u.className="slide-item";const m=K(s.content);u.innerHTML=`
      <div class="slide-item-header">
        <h3 class="slide-item__title">${s.title}</h3>
        <div class="slide-item-time">
          ${s.startTime} - ${s.endTime}
        </div>
      </div>
      <div class="duration-slider-container">
        <input type="range" min="0" max="60" value="${s.duration}" class="duration-slider" data-slide-id="${s.id}">
        <span class="duration-display">${parseInt(s.duration,10)} min</span>
      </div>
      <div class="slide-item-content">${m}</div>
    `,n.appendChild(u)}),n.querySelectorAll(".duration-slider").forEach(s=>{s.addEventListener("input",V),s.addEventListener("change",Q)})}const T=C(async()=>{if(g){const t=`timetable-${v}`;X(t,g),console.log("Timetable saved.")}},500);function V(t){const n=parseInt(t.target.value,10),e=t.target.nextElementSibling;e&&(e.textContent=`${n} min`)}function Q(t){const n=t.target.getAttribute("data-slide-id"),e=parseInt(t.target.value,10),a=g.items.find(o=>o.id===n);if(a){a.duration=e;const o=x(g);w(o),T()}const i=t.target.nextElementSibling;i&&(i.textContent=`${e} min`)}function x(t){const n=new Date(`1970-01-01T${t.startTime}:00`);let e=0;const a=t.items.map(i=>{const o=new Date(n),l=i.duration;n.setMinutes(n.getMinutes()+l);const r=new Date(n);return e+=l,{...i,startTime:o.toTimeString().slice(0,5),endTime:r.toTimeString().slice(0,5)}});return{...t,items:a,totalDuration:e}}document.addEventListener("DOMContentLoaded",async()=>{console.log("[SIDEBAR] DOMContentLoaded fired"),await Y(),G()});async function Y(){try{console.log("[SIDEBAR] Initializing infrastructure..."),await y.initialize(),P=!0,console.log("[SIDEBAR] ConfigManager initialized"),await b.initialize(),O=!0,console.log("[SIDEBAR] AuthManager initialized"),console.log("[SIDEBAR] Clerk key present at build:",!0),await Z(),tt(),f([],"Infrastructure ready"),console.log("[SIDEBAR] Infrastructure ready")}catch(t){console.error("[SIDEBAR] Failed to initialize infrastructure:",t),console.log("[SIDEBAR] Continuing in fallback mode...")}}async function Z(){await $()}async function $(){const t=document.getElementById("auth-status-bar");if(!t)return;if(!(await y.getConfig()).features.authentication){t.style.display="none";return}t.style.display="none"}function tt(){b.addEventListener(async t=>{console.log("[SIDEBAR] Auth state changed:",t.type),await $(),f(I,`Auth event: ${t.type}`)})}
